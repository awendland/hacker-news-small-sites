<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>
<![CDATA[Hacker News - Small Sites - Score >= 50]]>
        </title>
        <description>
<![CDATA[Hacker News stories from domains that aren't in the top 1M and that have a score of at least 50. Updated nightly via https://github.com/awendland/hacker-news-small-sites]]>
        </description>
        <link>https://news.ycombinator.com</link>
        <generator>RSS for Node</generator>
        <lastBuildDate>Sun, 20 Dec 2020 12:43:11 GMT</lastBuildDate>
        <atom:link href="https://raw.githubusercontent.com/awendland/hacker-news-small-sites/generated/feeds/hn-small-sites-score-50.xml" rel="self" type="application/rss+xml"></atom:link>
        <pubDate>Sun, 20 Dec 2020 12:43:11 GMT</pubDate>
        <language>
<![CDATA[en-US]]>
        </language>
        <managingEditor>
<![CDATA[me@alexwendland.com (Alex Wendland)]]>
        </managingEditor>
        <ttl>240</ttl>
        <item>
            <title>
<![CDATA[Big Sur bug prevents upgrades to the next version]]>
            </title>
            <description>
<![CDATA[
Score 68 | Comments 6 (<a href="https://news.ycombinator.com/item?id=25463521">thread link</a>) | @groobongithub
<br/>
December 17, 2020 | https://micromdm.io/blog/big-sur-softwareupdate/ | <a href="https://web.archive.org/web/*/https://micromdm.io/blog/big-sur-softwareupdate/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div><div><p><br><span>Date: Thu, Dec 17, 2020</span><br><span>Reading Time: 7 minutes</span></p><p>If you work with Apple in some capacity, you know that they’re not very likely to admit mistakes. I’m not aware of Apple publishing postmortems after outages or providing details about known issues. So it’s up to the developer and admin communities at large to help each other learn about outages and potential causes. With the release of macOS 11.1 this week I’ve been debugging a new issue with the Mac software update process, one which will affect most enterprise users. I decided I should write about it and let everyone know what the issue is, workarounds, and how to avoid it. I’ve also been paying close attention to some recent changes to the software update mechanism, so I’ll try to mention them below as well.</p><h2 id="a-macos-11-bug-prevents-upgrades-to-the-next-version">A macOS 11 bug prevents upgrades to the next version</h2><p>After macOS 11.1 was released earlier this week, many users <a href="https://twitter.com/Contains_ENG/status/1339399335298166785">started reporting</a> that they were not able to see the software update. Others reported that they saw it, but were not able to download it. I personally experienced this issue when 11.1 was in beta and filed a case with Apple about it, but then moved on to other problems. When the final release came out this week, there were widespread reports of it on the MacAdmins Slack. Reading through system logs, I as well as other admins were able to find what appears to be the root cause. <strong>Under certain conditions, macOS 11.0.1 and macOS 11.1 hosts are requesting the update server send the 11.0.1 update, instead of requesting the next available one. The server rejects this update as it’s already either installed or older.</strong> This somehow corrupts the state of the software update process, and the update is no longer visible as an option in System Preferences.</p><figure><img src="https://micromdm.io/big_sur_softwareupdate/log.jpg"></figure><h3 id="workarounds">Workarounds</h3><ul><li>The update is visible again immediately after the restart. But it’s unclear if the update can always be installed after it’s visible since the condition that made it fail to download the first time can be triggered again.</li><li>Removing the MDM enrollment profile causes the update to be seen again. I and several others tested this extensively, and it’s definitely the enrollment profile, not some other policy managed by MDM. This is obviously a terrible workaround and I’d hesitate to mention it to users as it could cause security agents to stop working, and countless approval dialogs we’re so familiar with. Not to mention some of you have the MDM enrollment profile as non-removable or users who are not administrators, so they don’t have permission to unenroll. Getting them back enrolled in the MDM might prove to be a challenge too.</li><li>Distributing the full 11.1, and eventually the 11.2 installers.</li></ul><h3 id="can-apple-fix-this-bug-without-manual-intervention">Can Apple fix this bug without manual intervention?</h3><p>Apple is well aware this is a problem now, so I am confident the issue will be addressed in 11.2. Unfortunately, it is a client-side issue affecting both 11.0.1 and 11.1 clients. So there’s not much Apple <em>can</em> do to provide a fix. One potential solution I see is for Apple to detect the wrong request and instead of rejecting the download, offer the right file archive instead. But this is a complex system and it’s unclear if the server-side changes alone are enough.</p><p>Something else Apple could try is to side load a patch through another software update. There’s background configuration and malware removal tools that are likely capable of fixing the issue on the system. But it’s an ugly hack and one I’d personally stay clear of even if the option was available.</p><p>In my opinion, the most likely outcome is that the bug will be fixed in 11.2, but clients that have already upgraded to Big Sur (or any M1 macs you might’ve bought) will have to work around the problem themselves. If we’re lucky Apple will publish a support article and that will be that.</p><h2 id="what-else-you-need-to-know">What else you need to know</h2><p>Big Sur has changed the software update mechanism entirely, especially on Apple Silicon macs. It’s a long time coming and Apple spoke about some of this at WWDC in the MDM and IT sessions, so it shouldn’t be entirely surprising. But a lot was left unsaid for us to discover on our own.</p><ul><li>Combo update packages are <a href="https://eclecticlight.co/2020/12/17/apple-has-stopped-providing-standalone-installers-for-macos-updates/">no longer published</a> on the Apple website. This might surprise many of you who rely on distributing them. The main reason is that the entire format of the updates has changed, and it’s also no longer possible to install updates without the Mac having access to the internet. The updates must come from Apple, and they must be managed by <code>softwareupdate</code> and related processes on the system.</li><li>On Apple Silicon, third party processes are no longer able to script the <code>softwareupdate</code> command. Running the software update command as a root process now prompts for the administrator password, who also needs to be a secure token user. There are only two possible options for OS updates to be applied; either the human user of the device itself or the MDM process <a href="https://support.apple.com/guide/deployment-reference-macos/using-secure-and-bootstrap-tokens-apdff2cf769b/1/web/1.0">which has special permission</a>. It might also be possible for the Mac to update itself with the auto-update mechanism, but there are too many bugs right now to observe how well that works. My personal experience is that it doesn’t and I’m greeted with a password prompt to enter the next day…</li><li>Specifying a custom URL for the <code>softwareupdate</code> process to pull updates from is no longer possible. Apple advertised this deprecation for all of last year, so it should surprise no one but it hurts. <a href="https://github.com/wdas/reposado">Reposado</a> was one of several great tools that made it possible to have unstable/beta/stable tracks within an organization.</li><li>—ignore is gone as a flag. It <a href="https://mrmacintosh.com/10-15-5-2020-003-updates-changes-to-softwareupdate-ignore/">was gone</a> in 10.15.5 briefly too, so you likely know about this one. This time it’s gone for good and never coming back. An MDM server can delay the client from seeing OS updates for up to 90 days only, but that is the absolute maximum going forward. Even for a future major release like macOS 12. If this is important to you, file feedback for Apple to provide a second deferral option, specific to major version numbers.</li></ul><p>I work with the MDM protocol a lot day-to-day and have been <a href="https://micromdm.io/blog/os_update/">testing</a> software updates for a while. I was even <a href="https://micromdm.io/blog/wwdc20-what-s-new-in-managing/">optimistic</a> about what it would look like in Big Sur back in June. Apple had promised it’s an entirely new implementation, closer to what is available on iOS and that everything would work better than before. But we’re not off to a good start, and all the concerns I had for several years now are back. The <a href="https://developer.apple.com/documentation/devicemanagement/commands_and_queries">design</a> of OS updates in MDM is brittle, requiring multiple remote procedure calls to accomplish something that was previously done by a few lines of shell scripting. And that would be bad on its own, but the bad design is coupled with a buggy implementation; there are many known issues, besides the one I described above. Unless something drastically changes, we’re likely to see many months, if not years of software update bugs that are entirely out of our control.</p><p>Apple was never particularly great at building systems for the enterprise. But, until recently, the Unix components were available for software developers and system administrators to work with. The end result ended up being that if you made an investment within your organization, macOS was a great experience for end-users. It took a lot of work, but it was all achievable. Today, Apple is no better at developing systems that are required in the enterprise. But the ball is entirely in their court. Apple still makes great tools for consumers, and there will be a demand from employees to provide them with Apple gear. But, if Apple can’t start acting on our collective feedback, the experience of using a Mac in the workplace will quickly become unbearable to most.</p></div></div></div>]]>
            </description>
            <link>https://micromdm.io/blog/big-sur-softwareupdate/</link>
            <guid isPermaLink="false">hacker-news-small-sites-25463521</guid>
            <pubDate>Fri, 18 Dec 2020 03:35:11 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Two Hundred Different Misspellings of Schwarzenegger]]>
            </title>
            <description>
<![CDATA[
Score 52 | Comments 45 (<a href="https://news.ycombinator.com/item?id=25462660">thread link</a>) | @cowllin
<br/>
December 17, 2020 | https://www.watercoolertrivia.com/blog/schwarzenegger | <a href="https://web.archive.org/web/*/https://www.watercoolertrivia.com/blog/schwarzenegger">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div><p>Arnold Alois Schwarzenegger was born in Austria on July 30, 1947. Famously, he reached stratospheric levels of notoriety and success in three wholly distinct professional fields: bodybuilding, acting, and politics, culminating in his eight years as the Governor of California.&nbsp;<br></p><p>For the past 73 years, Schwarzenegger has gone by Arnold, Ahnuld, Governator, <a href="https://en.wikipedia.org/wiki/Arnold_Schwarzenegger">Austrian Oak</a>, Terminator, Running Man, and dozens of other nicknames. In part because he’s charismatic and there’s nicknames aplomb to describe him, sure.&nbsp;<br></p><p><strong>But also because his last name is hard to spell. Like, really hard.</strong> We would know, because Water Cooler Trivia participants have spelled Schwarzenegger 255 different ways. And we’ve dug deep to explore that data.&nbsp;<br></p><p>255 different spellings. <a href="https://www.watercoolertrivia.com/blog/feature-emojis"><strong>We don’t grade responses based on spellings</strong></a>, so these are the spellings we’ve accepted as correct. We’ve got the full list of them at the end of this article, but we wanted to dig deeper into the data<br></p><h2>First things first: here’s the trivia question<br></h2><blockquote><strong>“What is the name of the Austrian bodybuilder who has been Mr. Universe three times and Mr. Olympia seven times?”</strong><br></blockquote><p>The answer, as you’ve surely guessed by now, is Arnold Schwarzenegger. We first wrote this question in April 2019, and since then…</p><ul role="list"><li><strong>3,019 different participants</strong> across 306 different groups have submitted a response</li><li><strong>2,681</strong> (89%) of folks got the question correct</li><li><strong>1,616</strong> (60%) of correct responses were spelled correctly [editor’s note: we suspect phone and browser autocorrect software lent a helping hand here]</li><li><strong>255</strong> different spellings of Schwarzenegger during that time<br></li></ul><p>And now, let’s look at the different ways in which Schwarzenegger has been spelled by Water Cooler Trivia participants.&nbsp;</p><h2>1. What are the most common misspellings?</h2><p>When you remove the correct spelling, you are left with 1,060 participants who spelled Schwarzenegger in 254 different ways.&nbsp;<br></p><p>The most common misspelling is to simply add a <strong>T </strong>after the <strong>R</strong>, a.k.a <strong>Schwartzenegger</strong>. This makes sense, as Schwartz itself is a fairly common German surname. 116 different respondents, 4% of all correct responses, spelled Arnold’s surname with that bonus <strong>T.</strong><br></p><p>Next up was <strong>Schwarzeneger</strong>, which removes a letter rather than adding one, this time removing one of the two <strong>G</strong>s. Again, this matches intuition. Double letters are hard to remember and frequently don’t add anything phonetically to a word. 88 different participants spelled it with this missing <strong>G</strong>, or 3% of all correct responses.<br></p><p>In third place was <strong>Schwarzenager</strong> with 56 people (2% of correct responses) both dropping that same <strong>G </strong>and then also swapping an <strong>E </strong>with a <strong>G. </strong>We get it, spelling is hard.<br></p><p>Below is a chart of the ten most common misspellings, and for the intrepid, here’s the <a href="https://docs.google.com/spreadsheets/d/1QqEL1IZvox3Aypi0YDStZ3QJ2_WuMTPwp7pOJ2batPE/edit#gid=756356712">full list</a> of misspellings.</p><figure id="w-node-73dd971f4f5a-e7177fda"><p><img src="https://uploads-ssl.webflow.com/5eb9c1e4771ba53de5f5dbee/5fdbffcf08dd766ee0807d28_YMx1QfTHzO6c61u44T5MnhVihFk7AuJUa3aJXoUvDh8sLDYthwp4CYFclY0sUekxH3MYA1U9T9lu0OY0GBnxEtnBW-jUzNYQfk5iRSXSBP2musv3twFKBiNuMHwAPsVhEvrRVvUz.png" alt=""></p></figure><h2>2. Wait, how many letters is it?</h2><p>It’s 14 letters. S-c-h-w-a-r-z-e-n-e-g-g-e-r. But not everyone realized that.&nbsp;<br></p><p>Of the 255 total different spellings,&nbsp;</p><ul role="list"><li><strong>169</strong> (66%) had fewer than 14 letters</li><li><strong>24</strong> (9%) had more than 14 letters</li><li><strong>61</strong> (24%) correctly had 14 letters but were spelled incorrectly</li><li><strong>1</strong> (0.4%) correctly had 14 letters and was spelled correctly<br></li></ul><p>The most popular length was 13 letters with 31% of distinct spellings and 13% of all correct responses.</p><figure id="w-node-b1be6443de1a-e7177fda"><p><img src="https://uploads-ssl.webflow.com/5eb9c1e4771ba53de5f5dbee/5fdbffcf088a2f4f273d8970_jDn-VaUiTJ_o9aGXBHJpAgFsSNJ4qViTLF0n0X5ZsN1kWQFbC7nS7JO88_K3BwfEaYJEkkT60LeNMN6-x7CwXgXXpJPsO7JLx7fPFXYMxPmM2bmSAaVNS0g1ttJBCkZDVdFqo_jX.png" alt=""></p></figure><h2>3. So it starts with an S... then a C… then...</h2><p>Schwarzenegger starts with the letter S. That’s fairly obvious. In fact, of the 255 distinct spellings that accepted as correct, 100% of them started with the letter <strong>S</strong>. However, once you move on to the second letter, <strong>only 58% of the spellings had C as the second letter.</strong><br></p><p>Unsurprisingly, the share of “correct” letters in terms of positions descends as you get further in the word, with a few noticeable deviations: interestingly, misspellings tend to correctly guess that the 11th letter is a <strong>G</strong> and the 14th letter is an <strong>R</strong>.<strong>&nbsp;</strong></p><figure id="w-node-3153958d4ef7-e7177fda"><p><img src="https://uploads-ssl.webflow.com/5eb9c1e4771ba53de5f5dbee/5fdbffcf6ef4066cb3b8bc5a_SVo29XaQjA6jKuUkHuTPk1t2s967m2NoVPJrmpRPCGKe3Hrzg40C8kdhQvOqWkjw_BH_8noZ2ds0YGXkppq-B22DsD0PZ6auFQTHvSlEjpjzYw7r1Htdz5sFgWl7oAdN6pVAGp-6.png" alt=""></p></figure><h4>Double Letters</h4><p>On that topic, Schwarzenegger has a double letter in it: two G’s as the 11th and 12th letter. This was a common source of misspellings, as 1<strong>47 of the distinct spellings (58%) guessed that there was only one G</strong> in the politician’s surname.<br></p><h4>Edit Distance</h4><p>Known as edit distance or Levenshtein distance, this is a measure of how many changes you need to make to a word or phrase in order to translate it into another word or phrase. <strong>So “bake” has a distance of one from “cake” or “ake” or “baked”.</strong><br></p><p>When you search the internet for <strong>Girrafe</strong> and the search engine asks <strong><em>“Did you mean Giraffe?”</em></strong><em> </em>they are making that guess because your search query only had an edit distance of two from the more common query term <strong>Giraffe</strong>. One deletion (the first <strong>R</strong>) and one insertion (the second <strong>F</strong>) turns your query into the correct word.&nbsp;<br></p><p>So, basically, this is a way to see <strong><em>how bad </em></strong>certain spellings were. Or, more optimistically, how generous we at Water Cooler Trivia are as graders.&nbsp;<br></p><p>Okay, with all that prologue finished, here’s the edit distance stats for the 255 distinct spellings of Schwarzenegger. Note that we are only surfacing the 1,060 responses that were incorrectly spelled.&nbsp;</p><ul role="list"><li><strong>34% had an edit distance of only one</strong>!</li><li>And another 28% were only off by two characters!</li><li>18% of misspellings had an edit distance of at least four</li></ul><figure id="w-node-00b9f866edfc-e7177fda"><p><img src="https://uploads-ssl.webflow.com/5eb9c1e4771ba53de5f5dbee/5fdbffcfee56eb8449ae2563_Qw6LyfdHxuw1-KuhsN3NFHyHzwr-1PnjCWoBqcc6pBTMNmr1DKqO-LmCkjcwMx-wn3K4inzJcTAnSOQCLQokxfe_psFkS6F8YkA4ohbuvw5kcvg7D9ApQtGulyfaG4kXCjRYgV-r.png" alt=""></p></figure><h2>4. What does Schwarzenegger even mean?</h2><p>I was wondering that too. It turns out the name has Germanic roots, divided neatly into two terms.</p><ul role="list"><li>"schwarzen" means "black"</li><li>&nbsp;"egg" refers to a ridge<br></li></ul><p>So the Governator’s surname <strong>translates most literally into English as Black Ridge</strong>, which happens to be the name of a U.S. <a href="https://www.blackridge.us/"><strong>technology services company</strong></a>.</p><h2>Closing thoughts...</h2><p>Looking to learn about more commonly-misspelled names or commonly-mistaken knowledge? Us too! We have a dataset of 2.5 million free text trivia responses. If you want to work with us to mine for fun data-driven stories, email <a href="https://www.watercoolertrivia.com/cdn-cgi/l/email-protection#f89c998c99b88f998c9d8a9b9797949d8a8c8a918e9199d69b9795"><span data-cfemail="492d283d28093e283d2c3b2a2626252c3b3d3b203f2028672a2624">[email&nbsp;protected]</span></a> and we can find a way to work together.<br></p><p>Or if you just want to bring a <a href="https://www.watercoolertrivia.com/blog/how-weekly-trivia-impacts-your-mental-well-being"><strong>weekly trivia ritual</strong></a> to your team, that would make our hearts a-flutter. Get started with a four-week free trial at our <a href="http://watercoolertrivia.com/"><strong>homepage</strong></a>.<br></p></div></div>]]>
            </description>
            <link>https://www.watercoolertrivia.com/blog/schwarzenegger</link>
            <guid isPermaLink="false">hacker-news-small-sites-25462660</guid>
            <pubDate>Fri, 18 Dec 2020 01:15:14 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Reverse engineering the Nest home/away API]]>
            </title>
            <description>
<![CDATA[
Score 73 | Comments 16 (<a href="https://news.ycombinator.com/item?id=25459560">thread link</a>) | @emilburzo
<br/>
December 17, 2020 | https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/ | <a href="https://web.archive.org/web/*/https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div>
      
      
<p>A while ago I purchased a Nest camera because I liked the idea of only having to provide power and a WiFi connection to get a nice security system.</p>
<p>The fact that you could control it with <a href="https://support.google.com/googlenest/answer/9293712?hl=en">Works with Nest</a> (their open API) was a major factor in that decision.</p>
<p>Then Google bought Nest, and <a href="https://www.consumerreports.org/smart-home/things-to-know-about-works-with-nest-shutdown/">disabled access</a> for users who didn’t sign up in time (including me).</p>
<p>There were some promises that a new open API will be created “soon”.</p>
<p>Eventually, they released the <a href="https://developers.google.com/nest/device-access/api">Smart Device Management API</a>, and although you can do some things (get camera stream), you can’t set the “Home/Away” status.</p>
<p>Bummer.</p>

<p>You can read more about it <a href="https://support.google.com/googlenest/answer/9257400">here</a>, but <strong>TL;DR</strong> the Nest camera movement/sound alarms only trigger if it’s set to “Away”.</p>
<p>For reasons I don’t want to go into, the automatic Home/Away feature doesn’t work for me so I need a way to control it from code so it can be automated, as all good things.</p>

<p>Like all pros, my first try was to just open the Nest webapp with DevTools open, click the Home/Away toggle, copy as curl, run it from the CLI and… nothing.</p>
<p>Didn’t work.</p>
<p>Upon closer inspection I noticed the payload was binary, never a good sign :)</p>
<div><pre><code data-lang="bash">curl --data-binary <span>$'\nB\n\u001aSTRUCTURE_XXXXXXXXXXXXXXXX\u0012$XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\u0012\u0095\u0001\n\u000estructure_mode\u0012u\nTtype.nestlabs.com/nest.trait.occupancy.StructureModeTrait.StructureModeChangeRequest\u0012\u001d\u0008\u0002\u0010\u0001\u001a\u0017\n\u0015USER_XXXXXXXXXXXXXXXX\u001a\u000c\u0008ü¸Ìþ\u0005\u0010\u0080É\u0087¸\u0001'</span> <span>'https://grpc-web.production.nest.com/nestlabs.gateway.v1.ResourceApi/SendCommand'</span>  
</code></pre></div><p>(some details redacted)</p>

<p>The host endpoint at the end of the <code>curl</code> command was a very good hint that they are using <a href="https://grpc.io/">gRPC</a>, which I didn’t have any experience with so far.</p>
<p>On the gRPC website was our next clue:</p>
<blockquote>
<p>Define your service using Protocol Buffers, a powerful binary serialization toolset and language</p>
</blockquote>
<p>That matches the binary payload that we previously saw, now it’s getting exciting!</p>

<p>Since the simple payload replay didn’t do anything, I needed to figure out what’s actually in there.</p>
<p>The first (surprising) problem was actually just getting the binary payload into a text file, I guess the binary was getting messed up somewhere between the browser and the file I was pasting to.</p>
<p>The “Save all as HAR with content” feature was very helpful here, especially since there’s a base64 encoded field beneath the binary one.</p>
<p>Extracting that only took a bit of bash magic:</p>
<div><pre><code data-lang="bash">cat set-away-home.nest.com.har                           <span>\
</span><span></span>    | gron                                               <span>\
</span><span></span>    | grep <span>'json.log.entries[1].response.content.text'</span>   <span>\
</span><span></span>    | cut -d <span>'"'</span> -f <span>2</span>                                    <span>\
</span><span></span>    | base64 -d                                          <span>\
</span><span></span>    | base64 -d
</code></pre></div><p>(If you don’t know about <a href="https://github.com/tomnomnom/gron">gron</a>, you should definitely check it out, it makes JSON grep-able)</p>
<p>(No idea why it was base64-encoded twice)</p>

<p>Going through the official protobuf documentation it seemed like I needed the <code>.proto</code> files to do anything useful.</p>
<p>Which I couldn’t figure out how to extract from the Nest website, or if that’s even possible.</p>
<p>Luckily, I stumbled upon <code>protoc --decode_raw</code>, which gave the following output:</p>
<pre><code>1 {
  1 {
    1: "STRUCTURE_XXXXXXXXXXXXXXXX"
    2: "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
  }
  2 {
    1 {
      1: "STRUCTURE_XXXXXXXXXXXXXXXX"
      2: "structure_mode"
      3: "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
    }
    2: 4
    4 {
      1 {
        1: "type.nestlabs.com/nest.trait.occupancy.StructureModeTrait.StructureModeChangeResponse"
        2 {
          1: 1
        }
      }
    }
    6 {
      1 {
        1: "STRUCTURE_XXXXXXXXXXXXXXXX"
        2: "structure_mode"
        3: "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
      }
      2 {
        1: "type.nestlabs.com/nest.trait.occupancy.StructureModeTrait.StructureModeChangeRequest"
        2 {
          1: 2
          2: 1
          3 {
            1: "USER_XXXXXXXXXXXXXXXX"
          }
        }
      }
      3 {
        1: XXXXXXXXXX
        2: XXXXXXXXX
      }
    }
  }
}
15: ""
2: ""
15: "\000\000"
</code></pre><p>Quite a heavy payload to set a flag.</p>
<p>Then I tried to manually create the <code>.proto</code> files going by the output from above.</p>
<p>Not fun.</p>
<p>By luck (aka searching GitHub for those types) I found out that somebody a lot smarter than me had actually <a href="https://github.com/derek-miller/nest-protobuf">managed to extract the proto files</a> from the Nest website, thank you stranger!</p>

<p>Time to make use of those <code>.proto</code> files.</p>
<p>Start up the IDE and follow the protobuf tutorial on how to build a payload.</p>
<p>It was a lot harder than I expected.</p>
<p>I’m sure most of the hardness came from me never using protobuf before, but it also took me a bit to realize that they serialize the command we care about (<code>StructureModeChangeRequest</code>) into a generic type (<code>ResourceCommandRequest</code>) which is then also serialized.</p>
<p>Eventually I was able to send the protobuf payload to the Nest API and oh boy, seeing that icon switch from “Home” to “Away” was like an early christmas :)</p>
<p><img src="https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/images/nest-home-away.gif" alt="Nest home to away animation"></p>
<p>Hmm, but why isn’t the HTTP connection closing? It just hangs there.</p>
<p>Comparing the headers from the original request I could see that there’s an <code>X-Accept-Response-Streaming: true</code> header, adding it caused the connection to directly close as expected.</p>
<p>Strange, especially since <code>false</code> keeps the connection open. Mystery for another day.</p>
<p>I packaged everything nicely into a <a href="https://github.com/emilburzo/nest-rest">GitHub repo</a> and moved on to the last part.</p>

<p>The standard approach here would be to install some location tracker on all the “home” phones and periodically send it to a server which then decides when to toggle the Nest status.</p>
<p>Although I actually built an <a href="https://graticule.link/">android location sharing app</a>, I didn’t like this approach due to having to make a tradeoff between battery life and responsiveness.</p>
<p>I also looked into Google Location Sharing, but it involved creating another Google Account, permanently sharing my location with it and using that as the source. Too fragile.</p>
<p>The solution I went with in the end was:</p>
<ul>
<li>assign static IPs to all the relevant phones</li>
<li>try to connect to them from the internal network</li>
</ul>
<p>If the response is <code>connection refused</code>, they are on the network/“home”.</p>
<p>Anything else, they aren’t “home”.</p>
<p>Well, maybe also <code>connection accepted</code> if you’re weird and have a server on your phone.</p>
<p>I’m still surprised how well this works, because I read a lot of “don’t do this” online with reasons like:</p>
<ul>
<li>phones will automatically switch off their WiFi overnight</li>
<li>they won’t respond when they are in deep sleep</li>
<li>etc</li>
</ul>
<p>Maybe I got lucky, but it works, and it works very well:</p>
<pre><code>2020-12-17 09:36:07 INFO     found hosts: ['192.168.0.30', '192.168.0.31']
2020-12-17 09:36:07 INFO     192.168.0.30 is home
2020-12-17 09:36:09 INFO     set status to: home (200)
2020-12-17 09:41:09 INFO     192.168.0.30 is home
2020-12-17 09:46:13 INFO     192.168.0.31 is home
2020-12-17 09:51:17 INFO     192.168.0.31 is home
[..]
2020-12-17 11:17:29 INFO     set status to: away (200)
2020-12-17 12:35:11 INFO     192.168.0.31 is home
2020-12-17 12:35:12 INFO     set status to: home (200)
2020-12-17 12:40:16 INFO     192.168.0.31 is home
</code></pre><p>The switch from Away -&gt; Home is quicker than doing it by hand :)</p>
<p>I prepared another <a href="https://github.com/emilburzo/nest-home-away">GitHub repo</a>, fired everything up, and… it works!</p>

<p>It really sucks that I had to spend a day for something that either should just work, or at least I should have access to change on my own.</p>
<p>If the camera quality wasn’t so high I would have just ditched it and gone self-hosted with a DVR/NVR.</p>
<p>It would have taken longer to build all the features, but then I have control over every part.</p>
<p>The Nest app is still annoying me to migrate to a Google account, so let’s see for how long this solution actually works.</p>
    </div></div>]]>
            </description>
            <link>https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/</link>
            <guid isPermaLink="false">hacker-news-small-sites-25459560</guid>
            <pubDate>Thu, 17 Dec 2020 19:50:31 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Amazon disallows pointing out paid reviews]]>
            </title>
            <description>
<![CDATA[
Score 963 | Comments 422 (<a href="https://news.ycombinator.com/item?id=25459434">thread link</a>) | @kmod
<br/>
December 17, 2020 | http://blog.kevmod.com/2020/12/amazon-disallows-pointing-out-paid-reviews/ | <a href="https://web.archive.org/web/*/http://blog.kevmod.com/2020/12/amazon-disallows-pointing-out-paid-reviews/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div id="post-1067">
<p><span><span>17</span>Dec/20</span><span><a href="http://blog.kevmod.com/2020/12/amazon-disallows-pointing-out-paid-reviews/#comments">11</a></span></p>

<p>I recently bought a webcam from Amazon (late to the party, I know), and when it came it was fine but not amazing.</p>
<p>When I went through the packaging I saw a little card saying "send us a screenshot of your 5-star review and we'll give you a $10 Amazon gift card":</p>
<p><img src="http://blog.kevmod.com/wp-content/uploads/2020/12/IMG_16902.jpg" alt="$10 for 5-star reviews" width="400/"></p>
<p>I thought that other Amazon shoppers would want to know that this was happening and that the reviews were less trustworthy, so I wrote up a review and submitted it to Amazon.</p>
<p>Yesterday I got a notification that my review was rejected.  I heard of Amazon being ham-fisted about this stuff but it was still shocking that it would happen to me:</p>
<p><img src="http://blog.kevmod.com/wp-content/uploads/2020/12/screenshot.png" alt="Amazon review rejection"></p>
<p>I assume they rejected this due to the first rule, "Feedback on the seller ... should be provided [elsewhere]".  I could understand this being a good policy in some cases, but here they're using it to justify silencing talk about reviews.  I suppose we don't know whether they disallow positive comments about other reviews, but I would guess that that never happens.</p>
<p>I remember that I used to use Amazon ratings as the main driver behind my purchases, so it's sad to see the review system become less helpful over time.  It's extra sad that Amazon would rather try to hide the issue and not improve it.</p>
<p>Update:<br>
My premise was that the reviews section should be helpful for making purchasing decisions.  Some people (including Amazon) are saying that the reviews should be about the product, which is coherent but I would argue makes them less useful.  For example I feel quite helped when a review for chocolate mentions that the chocolate arrived melted -- this is not a review about the product intrinsically, but is still very helpful for deciding whether or not to buy the item.  Similarly, as a purchaser I would want to see a warning that there may be paid reviews for the product, and I was very surprised to learn that Amazon disallows such warnings.</p>
<p>Update 2:<br>
I submitted feedback through the link they requested, and here's the result:</p>
<p>https://www.amazon.com/sp?_encoding=UTF8&amp;asin=B087NN41JH&amp;isAmazonFulfilled=1&amp;ref_=olp_merch_name_1&amp;seller=AD5F1I5PAE5XB</p>
<p>I don't think this serves either goal of educating future purchasers or changing the sellers behavior.</p>
<p>Update 3:<br>
I've chatted with an Amazon rep on the issue, and to their credit they seemed to take it seriously and "noted the report violation against the seller".  They said to expect an update in 2-3 business days, though it's not clear what sort of update it will be.</p>







</div></div>]]>
            </description>
            <link>http://blog.kevmod.com/2020/12/amazon-disallows-pointing-out-paid-reviews/</link>
            <guid isPermaLink="false">hacker-news-small-sites-25459434</guid>
            <pubDate>Thu, 17 Dec 2020 19:39:17 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Show HN: Make comic book layouts in the browser]]>
            </title>
            <description>
<![CDATA[
Score 180 | Comments 33 (<a href="https://news.ycombinator.com/item?id=25455659">thread link</a>) | @TiredGuy
<br/>
December 17, 2020 | https://andrewfulrich.gitlab.io/panelle/ | <a href="https://web.archive.org/web/*/https://andrewfulrich.gitlab.io/panelle/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/>Unable to extract article]]>
            </description>
            <link>https://andrewfulrich.gitlab.io/panelle/</link>
            <guid isPermaLink="false">hacker-news-small-sites-25455659</guid>
            <pubDate>Thu, 17 Dec 2020 14:07:08 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[More information on the plant disturbance at Olkiluoto 2]]>
            </title>
            <description>
<![CDATA[
Score 86 | Comments 33 (<a href="https://news.ycombinator.com/item?id=25455279">thread link</a>) | @ericdanielski
<br/>
December 17, 2020 | https://www.tvo.fi/en/index/news/pressreleasesstockexchangereleases/2020/moreinformationontheplantdisturbanceatolkiluoto2.html | <a href="https://web.archive.org/web/*/https://www.tvo.fi/en/index/news/pressreleasesstockexchangereleases/2020/moreinformationontheplantdisturbanceatolkiluoto2.html">archive.org</a>
<br/><!-- hnss:readable-content --><hr/>Unable to retrieve article]]>
            </description>
            <link>https://www.tvo.fi/en/index/news/pressreleasesstockexchangereleases/2020/moreinformationontheplantdisturbanceatolkiluoto2.html</link>
            <guid isPermaLink="false">hacker-news-small-sites-25455279</guid>
            <pubDate>Thu, 17 Dec 2020 13:18:32 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[How to let go of a lifelong dream]]>
            </title>
            <description>
<![CDATA[
Score 63 | Comments 33 (<a href="https://news.ycombinator.com/item?id=25455014">thread link</a>) | @known
<br/>
December 17, 2020 | https://psyche.co/guides/how-to-let-go-of-a-lifelong-dream-and-redirect-your-passion | <a href="https://web.archive.org/web/*/https://psyche.co/guides/how-to-let-go-of-a-lifelong-dream-and-redirect-your-passion">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div><section><div><h2 data-guide-section-number="1"><span>Need to know</span></h2><div><p>Emma Garber began dancing aged three. By the time she was a teenager â€“ following years of dedicated, exhausting, sometimes painful training â€“ it was her burning ambition to become a professional ballet dancer. â€˜I think around age 14, I sat my parents down and I said: <em>This is what I want to do with my life. This is what makes me happy</em>,â€™ she says.</p>
<p>All of us have dreams and hopes for our future. They are often career-focused, but not always. Some people dream of starting a family or living in another country, for instance. Our dreams form part of our identity, giving us purpose and direction. That is, until reality gets in the way, as so often happens: the change might come from within us, as our passion wanes, or the obstacles to realising the dream might become insurmountable (or a mixture of the two).</p>
<p>Garberâ€™s dream began to fade amid burnout and doubt during her freshman year at the University of Massachusetts. After a particularly terrible dance class, she recalls: â€˜I was like, <em>I donâ€™t think I want to do this for the rest of my life</em>. I stood up, I walked out, I called my mom and I was like, <em>I donâ€™t even know what I want to do with my life anymore</em>.â€™</p>
<p>You might be experiencing one of these unsettling fork-in-the-road moments yourself. Perhaps the dying breath of a fading dream is leaving you with intense feelings of regret and failure. You might fear how others will judge you. After all, in todayâ€™s culture, in many parts of the world, weâ€™re taught from a young age that success is born from stubborn perseverance.</p>
<p>â€˜To be gritty,â€™ writes the psychologist Angela Duckworth in her bestselling <a href="https://www.penguin.co.uk/books/110/1109188/grit/9781785042669.html" rel="nofollow noreferrer noopener">book</a> <em>Grit</em> (2016), â€˜is to fall down seven times, and rise eight.â€™ The gist of her advice has echoed through different eras. â€˜Many of lifeâ€™s failures are people who did not realise how close they were to success when they gave up,â€™ wrote the inventor Thomas Edison.</p>
<p>Given this dominant narrative of the virtues of perseverance, and considering how our ambitions can become a core part of our sense of self, itâ€™s understandable that you might be finding it difficult and unsettling to face the prospect of losing your dream. You can take comfort, though, in knowing that being adaptable and flexible in oneâ€™s ambitions is just as important as being gritty or determined. â€˜By definition, if you cannot achieve what you want to achieve, you will fail repeatedly if you donâ€™t stop,â€™ says Carsten Wrosch, a psychology professor at Concordia University in Montreal, who has been studying the construct of â€˜goal adjustment capacityâ€™ for more than 20 years.</p>
<p>Goal adjustment capacity â€“ which psychologists <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/jopy.12492" rel="nofollow noreferrer noopener">see</a> as a beneficial form of â€˜self-regulationâ€™ or â€˜self-managementâ€™ â€“ encapsulates two key components: the ability to disengage from fruitless goals and the ability to reengage in new, more productive goals. You could see it as knowing when and how to switch from one dream to another. Itâ€™s measured by agreement with questionnaire items such as â€˜Itâ€™s easy for me to stop thinking about the goal and let it goâ€™ and â€˜I tell myself that I have a number of other new goals to draw upon.â€™</p>
<p>Wrosch says that people who lack this capacity are inclined to â€˜bang their head against the wallâ€™ when theyâ€™re confronted by an unobtainable goal, and, long-term, theyâ€™re more prone to stress and chronic illness. In contrast, those with greater adjustment capacity â€˜have a much easier timeâ€™ â€“ they decommit to the fruitless goal and find a different ambition to pursue. The virtues of being flexible and adaptable are also recognised by careers researchers, who <a href="https://www.sciencedirect.com/science/article/abs/pii/S0001879116300604" rel="nofollow noreferrer noopener">refer</a> to â€˜career adaptabilityâ€™, aspects of which involve being curious about new opportunities and being confident in oneâ€™s ability to learn new skills. People who score highly in this trait are generally â€˜happier. They perform better. They get promoted â€¦ Just a whole range of good things,â€™ says Rajiv Amarnani, a lecturer in the University of Western Australia Business School. That youâ€™re contemplating giving up your dream suggests that you have a healthy willingness to adjust and adapt, which is to your advantage.</p>
<p>If youâ€™re nonetheless finding it difficult to look beyond the immediate sense of loss or failure, know that there are routes ahead and that other opportunities will emerge. By having the wisdom and flexibility to know when to let go, or when to redirect your passion, youâ€™ll be following in the footsteps of many who have achieved greatness. David Foster Wallace let go of his tennis-greatness dreams and became an acclaimed novelist and writer instead. Meanwhile, Roger Federerâ€™s dreams of tennis greatness came true, but only at the expense of his dream of becoming a professional footballer. And Maryam Mirzakhani let go her childhood dream of becoming a novelist but went on to be awarded the Fields Medal for mathematics in 2014 â€“ the first and only woman ever to receive the honour.</p>
<p>These are dramatic examples, but they show that the path to fulfilment isnâ€™t always smooth or direct. Once youâ€™ve come to terms with your loss, youâ€™ll find other passions. New dreams await.</p></div></div></section><section><div><h2 data-guide-section-number="2"><span>What to do</span></h2><div><p><strong>Come to terms with your decision</strong></p>
<p>As you let your dream go, you might be agonising over whether youâ€™re making a mistake. â€˜Thereâ€™s no good answer, thereâ€™s no formulaâ€™ for deciding whether to plough on or give up, says Wrosch. However, he recommends bearing in mind a phenomenon known as â€˜goal shieldingâ€™ â€“ when weâ€™re highly focused on a particular dream or ambition, we tend to filter out inconvenient information that might imperil the project. â€˜Motivational psychologists call it an â€œimplemental mindsetâ€�,â€™ says Wrosch. â€˜If you cross the Rubicon, you focus on what you want to achieve, and you donâ€™t have that balance [in how you process the situation] any more.â€™ For that reason, he says most us are, if anything, probably more at risk of stubbornly pursuing a dream for too long than giving up too early.</p>
<p>The author and entrepreneur Seth Godin agrees with Wrosch â€“ â€˜thereâ€™s no calculusâ€™ for deciding when to give up, he says. He too warns that most of us â€˜lie to ourselves all the time about whether we have the resources to get through the dipâ€™. â€˜The dipâ€™ is Godinâ€™s term â€“ taken from his 2007 <a href="https://www.penguinrandomhouse.com/books/300938/the-dip-by-seth-godin/" rel="nofollow noreferrer noopener">book</a> of the same name, and subtitled <em>A Little Book That Teaches You When to Quit (and When to Stick)</em> â€“ that he says refers to the â€˜difficult space in between the joy of starting and the benefit of getting to the other sideâ€™.</p>
<p>One way to think about this emotionally difficult moment is as a chance to be objective about your dream. Was pursuing it coming at great personal cost, in terms of your relationships and other goals in life? If so, that would suggest it was what psychologists call an â€˜obsessive passionâ€™ and youâ€™re wise to give it up (as distinct from a â€˜harmonious passionâ€™ that fits well into the rest of your life).</p>
<p>Also, try to think, if you can, more like a â€˜healthy perfectionistâ€™: recognise that letting go of your goals doesnâ€™t cast some final verdict on you as a person, and acknowledge the influence of circumstances beyond your control. Remember too that success isnâ€™t all or nothing â€“ although you might not have fulfilled your dream in its entirety, you will likely have learned much along the way, and you now have the chance to redirect your energy and passion in new ways. This is also a good time to seek the counsel of close family and friends. Theyâ€™ll be able to help you view your situation objectively and come to terms with your decision.</p>
<p><strong>Be realistic about what you just gave up</strong></p>
<p>When you decide to let go of a dream, itâ€™s almost inevitable that itâ€™s going to hurt, at least for a time, but there are ways to ease the discomfort and move on. â€˜My approach to this is starting with the tragic realism of it, that itâ€™s going to be hard, itâ€™s going to hurt,â€™ says Amarnani, who likens the experience of giving up a dream to a romantic breakup. â€˜To have an ambition is to have this vision of your future self, and to drop that is to drop a piece of you,â€™ he says.</p>
<p>That parallel with relationships offers an effective clue for how to cope. In the context of romantic relationships, Amarnani says that it can be therapeutic to be realistic, rather than idealistic, about the person youâ€™re breaking from, even to focus deliberately on their flaws. If weâ€™re honest, many of our dreams are romanticised, and itâ€™s worth remembering that what youâ€™re giving up is not that fantasy version of the future. We think of doctors as healing people, says Amarnani, or that staff at the United Nations are building peace, but then their daily reality is often far more mundane â€“ doctors are navigating the bureaucracy of their healthcare system; workers at the UN are pushing paperwork around.</p>
<p>Amarnani speaks partly from personal experience. He once harboured a dream to become a computational cognitive neuroscientist, but he suffered repeated rejections and then the financial crisis hit. He changed gears to become a management scholar â€“ â€˜I thought I was selling my soul,â€™ he says, â€˜but really what I was doing was just adjusting to the situation, being adaptable and trusting that, when you try something new, the passion will come.â€™ To help make peace with his decision, Amarnani focused on the negatives of the field he gave up â€“â€˜Decades of research on the brain has taught us next to nothing about the mindâ€™ â€“ and today he couldnâ€™t be happier that he gave up his dream. â€˜I grieved, genuinely,â€™ he says, â€˜but life does go on.â€™</p>
<p><strong>Find a new passion</strong></p>
<p>Itâ€™s a clichÃ© to say that one door closing means another opening, but itâ€™s true. By letting go of an impossible dream, youâ€™re freeing yourself to put time and effort into a potentially more rewarding project. Itâ€™s tempting to look at a high achiever such as Godin and assume that he arrived at his …</p></div></div></section></div></div>
<br/><p><em>Article truncated for RSS feed. Read the full article at <a href="https://psyche.co/guides/how-to-let-go-of-a-lifelong-dream-and-redirect-your-passion">https://psyche.co/guides/how-to-let-go-of-a-lifelong-dream-and-redirect-your-passion</a></em></p>]]>
            </description>
            <link>https://psyche.co/guides/how-to-let-go-of-a-lifelong-dream-and-redirect-your-passion</link>
            <guid isPermaLink="false">hacker-news-small-sites-25455014</guid>
            <pubDate>Thu, 17 Dec 2020 12:37:57 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[51% of 4M Docker images have critical vulnerabilities]]>
            </title>
            <description>
<![CDATA[
Score 323 | Comments 164 (<a href="https://news.ycombinator.com/item?id=25454207">thread link</a>) | @AnnieNma
<br/>
December 17, 2020 | https://thechief.io/c/news/51-4-million-docker-images-have-critical-vulnerabilities/ | <a href="https://web.archive.org/web/*/https://thechief.io/c/news/51-4-million-docker-images-have-critical-vulnerabilities/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/>Unable to retrieve article]]>
            </description>
            <link>https://thechief.io/c/news/51-4-million-docker-images-have-critical-vulnerabilities/</link>
            <guid isPermaLink="false">hacker-news-small-sites-25454207</guid>
            <pubDate>Thu, 17 Dec 2020 10:09:16 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Static Calls in Linux 5.10]]>
            </title>
            <description>
<![CDATA[
Score 91 | Comments 19 (<a href="https://news.ycombinator.com/item?id=25453663">thread link</a>) | @ingve
<br/>
December 17, 2020 | https://blog.yossarian.net/2020/12/16/Static-calls-in-Linux-5-10 | <a href="https://web.archive.org/web/*/https://blog.yossarian.net/2020/12/16/Static-calls-in-Linux-5-10">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page">


<h2><em>Programming, philosophy, pedaling.</em></h2>

<ul>
    <li><a href="https://blog.yossarian.net/">Home</a></li>
    <li><a href="https://blog.yossarian.net/tags">Tags</a></li>
    <li><a href="https://blog.yossarian.net/favorites">Favorites</a></li>
    <li><a href="https://blog.yossarian.net/archive">Archive</a></li>
    
      <li><a href="https://yossarian.net/">Main Site</a></li>
    
</ul>

<hr>



<h2>
  <em>Dec 16, 2020</em>
</h2>

  <p>Tags:
  
    
    <a href="https://blog.yossarian.net/tags#programming">programming</a>,
    
  
    
    <a href="https://blog.yossarian.net/tags#c">c</a>,
    
  
    
    <a href="https://blog.yossarian.net/tags#curiosity">curiosity</a>,
    
  
    
    <a href="https://blog.yossarian.net/tags#security">security</a>,
    
  
    
    <a href="https://blog.yossarian.net/tags#x86">x86</a>
    
  
  </p>


<p>I was reading the
<a href="https://kernelnewbies.org/Linux_5.10">Linux 5.10 release summary on KernelNewbies</a>, and a
section stood out to me:</p>

<blockquote>
  <p>1.6. Static calls for improved post-Spectre performance</p>

  <p>Static calls are a replacement for global function pointers. They use code patching to allow
direct calls to be used instead of indirect calls. They give the flexibility of function pointers,
but with improved performance. This is especially important for cases where retpolines would
otherwise be used, as retpolines can significantly impact performance.</p>
</blockquote>

<p>I’ve spent a lot of time looking at the Linux kernel, but never directly at its indirect call
setup or post-<a href="https://spectreattack.com/">Spectre</a> mitigations. These changes sound very cool,
so I’m going to use this post to try and explain and understand them (both to myself and others).</p>

<p><strong>Update</strong>: One of the original authors of the patchset has emailed me with some corrections
and answers to the questions that I ask below. I’ve marked each with either “Correction” or
“Update.” Thanks, Peter!</p>

<h2 id="background-indirect-calls-spectre-and-retpolines">Background: indirect calls, Spectre, and retpolines</h2>

<h3 id="indirect-calls">Indirect calls</h3>

<p>Indirect calls are one of C’s most powerful language features, and are critical for writing
higher-order code without a supplementary object or function/method dispatch system.</p>

<p>Most C programmers are familiar with the basics of indirect calls, thanks to standard and POSIX
functions like <code>qsort</code> and <code>pthread_create</code>: each takes a <em>function pointer</em>, which it then
calls internally to complete the functionality of the surrounding call:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td><pre><span>#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;stdio.h&gt;
</span>
<span>/* qsort_strcmp is just the normal stdlib strcmp, with a bit of extra parameter
 * munging to match qsort's API.
 */</span>
<span>static</span> <span>int</span> <span>qsort_strcmp</span><span>(</span><span>const</span> <span>void</span> <span>*</span><span>a</span><span>,</span> <span>const</span> <span>void</span> <span>*</span><span>b</span><span>)</span> <span>{</span>
    <span>return</span> <span>strcmp</span><span>(</span><span>*</span><span>(</span><span>const</span> <span>char</span> <span>**</span><span>)</span><span>a</span><span>,</span> <span>*</span><span>(</span><span>const</span> <span>char</span> <span>**</span><span>)</span><span>b</span><span>);</span>
<span>}</span>

<span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
    <span>const</span> <span>char</span> <span>*</span><span>strings</span><span>[]</span> <span>=</span> <span>{</span><span>"foo"</span><span>,</span> <span>"bar"</span><span>,</span> <span>"baz"</span><span>};</span>

    <span>/* qsort is a generic sorting function:
     * you give it the a pointer to the base address of things to sort,
     * their number and individual sizes, and a *function* that can compare
     * any two members and provide an ordering between them.
     *
     * in this case, we tell qsort to sort an array of strings, using
     * `qsort_strcmp` for the ordering.
     */</span>
    <span>qsort</span><span>(</span><span>&amp;</span><span>strings</span><span>,</span> <span>3</span><span>,</span> <span>sizeof</span><span>(</span><span>char</span> <span>*</span><span>),</span> <span>qsort_strcmp</span><span>);</span>

    <span>printf</span><span>(</span><span>"%s %s %s</span><span>\n</span><span>"</span><span>,</span> <span>strings</span><span>[</span><span>0</span><span>],</span> <span>strings</span><span>[</span><span>1</span><span>],</span> <span>strings</span><span>[</span><span>2</span><span>]);</span>
    <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><em>(View it on <a href="https://godbolt.org/z/vbn7zW">Godbolt</a>).</em></p>

<p>In this case, the indirect call occurs within <code>qsort</code>. But we can see it directly if
we implement our own function that does an indirect call:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td><pre><span>static</span> <span>uint32_t</span> <span>good_rand</span><span>()</span> <span>{</span>
    <span>uint32_t</span> <span>x</span><span>;</span>
    <span>getrandom</span><span>(</span><span>&amp;</span><span>x</span><span>,</span> <span>sizeof</span><span>(</span><span>x</span><span>),</span> <span>GRND_NONBLOCK</span><span>);</span>
    <span>return</span> <span>x</span><span>;</span>
<span>}</span>

<span>static</span> <span>uint32_t</span> <span>bad_rand</span><span>()</span> <span>{</span>
    <span>return</span> <span>rand</span><span>();</span>
<span>}</span>

<span>/* munge takes a function pointer, rand_func, which it calls
 * as part of its returned result.
 */</span>
<span>static</span> <span>uint32_t</span> <span>munge</span><span>(</span><span>uint32_t</span> <span>(</span><span>*</span><span>rand_func</span><span>)(</span><span>void</span><span>))</span> <span>{</span>
    <span>return</span> <span>rand_func</span><span>()</span> <span>&amp;</span> <span>0xFF</span><span>;</span>
<span>}</span>

<span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
    <span>uint32_t</span> <span>x</span> <span>=</span> <span>munge</span><span>(</span><span>good_rand</span><span>);</span>
    <span>uint32_t</span> <span>y</span> <span>=</span> <span>munge</span><span>(</span><span>bad_rand</span><span>);</span>

    <span>printf</span><span>(</span><span>"%ul, %ul</span><span>\n</span><span>"</span><span>,</span> <span>x</span><span>,</span> <span>y</span><span>);</span>

    <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>where <code>munge</code> boils down to:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td><pre><span>munge:</span>
  <span>push</span>    <span>rbp</span>
  <span>mov</span>     <span>rbp</span><span>,</span> <span>rsp</span>
  <span>sub</span>     <span>rsp</span><span>,</span> <span>16</span>
  <span>mov</span>     <span>qword</span> <span>ptr</span> <span>[</span><span>rbp</span> <span>-</span> <span>8</span><span>],</span> <span>rdi</span>  <span>; load rand_func</span>
  <span>call</span>    <span>qword</span> <span>ptr</span> <span>[</span><span>rbp</span> <span>-</span> <span>8</span><span>]</span>       <span>; call rand_func</span>
  <span>and</span>     <span>eax</span><span>,</span> <span>255</span>
  <span>add</span>     <span>rsp</span><span>,</span> <span>16</span>
  <span>pop</span>     <span>rbp</span>
  <span>ret</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><em>(View it on <a href="https://godbolt.org/z/P44Ghq">Godbolt</a>).</em></p>

<p>Observe: our <code>call</code> goes through a memory or register operand (<code>[rbp - 8]</code>)<sup id="fnref:opt" role="doc-noteref"><a href="#fn:opt">1</a></sup> to get the target,
instead of a direct target specified by the operand value itself (like, say,
<code>call 0xacabacab ; @good_rand</code>). That’s what makes it indirect.</p>

<p>But we can go even further than this! Indeed, a common pattern in C is to declare
entire <em>structures</em> of operations, using each to parametrize a lower level set of behaviors
(for example, the core POSIX I/O APIs) over independent implementations.</p>

<p>This is exactly how <a href="https://github.com/libfuse/libfuse">FUSE</a> works: every FUSE client
creates its own <a href="https://github.com/libfuse/libfuse/blob/cd4aae2de6aacad31a15791bbb52adf173561a6d/include/fuse.h#L299-L790"><code>fuse_operations</code></a>:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td><pre><span>struct</span> <span>fuse_operations</span> <span>{</span>
  <span>int</span> <span>(</span><span>*</span><span>getattr</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>struct</span> <span>stat</span> <span>*</span><span>,</span> <span>struct</span> <span>fuse_file_info</span> <span>*</span><span>fi</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>readlink</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>char</span> <span>*</span><span>,</span> <span>size_t</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>mknod</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>mode_t</span><span>,</span> <span>dev_t</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>mkdir</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>mode_t</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>unlink</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>rmdir</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>symlink</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>rename</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>,</span> <span>unsigned</span> <span>int</span> <span>flags</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>link</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>);</span>
  <span>/* ... */</span>
  <span>int</span> <span>(</span><span>*</span><span>open</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>struct</span> <span>fuse_file_info</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>read</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>char</span> <span>*</span><span>,</span> <span>size_t</span><span>,</span> <span>off_t</span><span>,</span>
         <span>struct</span> <span>fuse_file_info</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>write</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>,</span> <span>size_t</span><span>,</span> <span>off_t</span><span>,</span>
          <span>struct</span> <span>fuse_file_info</span> <span>*</span><span>);</span>
  <span>int</span> <span>(</span><span>*</span><span>statfs</span><span>)</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>,</span> <span>struct</span> <span>statvfs</span> <span>*</span><span>);</span>
  <span>/* ... */</span>
<span>}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Unsurprisingly, this technique isn’t limited to userspace: the Linux kernel itself makes
aggressive use of indirect calls, particularly in architecture-agnostic interfaces
(like the <a href="https://www.kernel.org/doc/html/latest/filesystems/vfs.html">VFS</a> and sub-specializations
like <code>procfs</code>) and the architecture-specific internals of subsystems like
<a href="https://perf.wiki.kernel.org/index.php/Main_Page"><code>perf_events</code></a>.</p>

<p>So that’s neat. It’s so neat that CPU engineers got all
<a href="https://en.wikipedia.org/wiki/Branch_predictor#Indirect_branch_predictor">hot in the pants</a> trying
to squeeze extra performance out of them<sup id="fnref:perf" role="doc-noteref"><a href="#fn:perf">2</a></sup>, and we ended up with
<a href="https://spectreattack.com/spectre.pdf">Spectre v2</a>.</p>

<h3 id="spectre-v2">Spectre (v2)</h3>

<p><img src="https://blog.yossarian.net/assets/spectre.png" alt="The Spectre logo"></p>

<p>The exact mechanism that Spectre v2 (also known as
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-5715">CVE-2017-5715</a>) exploits is
<em>slightly</em> out of scope of this post, but at a high level:</p>

<ol>
  <li>
    <p>Modern (x86) CPUs contain an <em>indirect branch predictor</em>, which attempts to guess the target
of an indirect call or jump.</p>

    <p>To actually speed things up, the CPU <strong>speculatively executes</strong> the
 predicted branch:</p>

    <ul>
      <li>
        <p>A correct prediction means that the indirect call completes significantly faster
 (since it’s already executing or has finished executing speculatively);</p>
      </li>
      <li>
        <p>A misprediction <strong>should</strong> result in a slower (but still
 successful) indirect call with <strong>no side effects from the incorrect speculation.</strong></p>
      </li>
    </ul>

    <p>In other words: the CPU is responsible for <strong>rolling back</strong> any side effects associated
 with any misprediction and subsequent speculation. Mis-speculation is a <em>microarchitectural</em>
 detail that should not manifest in <em>architectural</em> changes, like modified registers.</p>
  </li>
  <li>
    <p><strong>Rolling back</strong> any mis-speculated state is a relatively expensive operation, with a lot of
microarchitectural implications: cache lines and other bits of state need to be fixed up so that
the <em>actual</em> program control flow isn’t tainted by failed speculations.</p>

    <p>In practice, rolling back the entire speculated state would undo most of the advantages
 of speculating in the first place. Instead of doing that, x86 and other ISAs will just mark
 (many) of the bits of speculated state (like cache lines) as stale.</p>
  </li>
  <li>
    <p>This fixup behavior (either reverting or marking speculated state) results in a
<a href="https://en.wikipedia.org/wiki/Side-channel_attack"><em>side-channel</em></a>: an attacker can
<em>train</em> the branch predictor to speculatively execute a bit of code
(not unlike a <a href="https://en.wikipedia.org/wiki/Return-oriented_programming">ROP gadget</a>) that modifies
a piece of microarchitectural state in a data-dependent manner, such as a cache entry
whose address is dependent on a secret value that was speculatively fetched.</p>

    <p>The attacker can then <em>probe</em> that microarchitectural state by <strong>timing</strong> access to it:
 fast accesses indicate a speculatively modified state, disclosing the secret.</p>
  </li>
</ol>

<p>The original Spectre v2 attack focused on cache lines since they’re relatively easy to time, even
from high level (and sandboxed!) languages that don’t have access to
<a href="https://c9x.me/x86/html/file_module_x86_id_30.html"><code>clflush</code></a> or other cache-line
primitives on x86. But the concept is a general one: it’s difficult to execute speculatively without
leaking <em>some</em> information, and subsequent vulnerabilities (like <a href="https://mdsattacks.com/">MDS</a> and
<a href="https://zombieloadattack.com/">ZombieLoad</a>) have exposed information leaks in other
microarchitectural features.</p>

<p>This is bad news: an attacker running one of the <strong>safest</strong> contexts (JavaScript or other managed
code, in a sandbox, in userspace) can conceivably train the indirect branch predictor to
speculatively execute a gadget in kernelspace, potentially
<a href="https://cyber.wtf/2017/07/28/negative-result-reading-kernel-memory-from-user-mode/">disclosing kernel memory</a>.</p>

<p>So, the kernel needed a new mitigation. That mitigation is <em>retpolines</em>.</p>

<h3 id="retpolines">Retpolines</h3>

<p>To mitigate Spectre v2, the kernel needs to prevent the CPU from speculating on an attacker
controlled indirect branch.</p>

<p>A retpoline (short for <em>ret</em>urn
<a href="https://en.wikipedia.org/wiki/Trampoline_(computing)"><em>trampoline</em></a>) does exactly that: indirect
jumps and calls are surrounded by a little <a href="https://en.wikipedia.org/wiki/Thunk">thunk</a> that
effectively traps the speculated execution in an infinite loop, spinning it until the misprediction
is resolved.</p>

<p>Intel’s
<a href="https://software.intel.com/security-software-guidance/api-app/sites/default/files/Retpoline-A-Branch-Target-Injection-Mitigation.pdf">Retpoline whitepaper</a>
has some helpful illustrations:</p>

<p><img src="https://blog.yossarian.net/assets/retpoline.png" alt="A visualization of speculative execution with and without a retpoline."></p>

<p>This works by converting the indirect control flow from an <em>indirect branch</em> to an
<em>indirect return</em><sup id="fnref:allreturns" role="doc-noteref"><a href="#fn:allreturns">3</a></sup>, hence the “ret” in retpoline. Returns are <em>also</em> predicted,
but with an additional mechanism given priority: the
<a href="https://blog.stuffedcow.net/2018/04/ras-microbenchmarks/">Return Stack Buffer</a><sup id="fnref:rsb" role="doc-noteref"><a href="#fn:rsb">4</a></sup>. To ensure that
the RSB can’t be maliciously trained away from the infinite loop, the retpoline begins with a
direct <code>CALL</code> that primes the RSB to always<sup id="fnref:notalways" role="doc-noteref"><a href="#fn:notalways">5</a></sup> predict the infinite loop.</p>

<p>Here’s what an indirect call retpoline <em>actually</em> looks like<sup id="fnref:ool" role="doc-noteref"><a href="#fn:ool">6</a></sup>, simplified significantly from
the <a href="https://elixir.bootlin.com/linux/v5.9.14/source/arch/x86/lib/retpoline.S">kernel</a>
<a href="https://elixir.bootlin.com/linux/v5.9.14/source/arch/x86/include/asm/nospec-branch.h">source</a>:</p>

<div><div><pre><code><table><tbody><tr><td><pre>1
2
3
4
5
6
7
8
9
</pre></td><td><pre><span>__x86_retpoline_rax:</span>
  <span>call</span> <span>.Ldo_rop_0</span>
<span>.Lspec_trap_0:</span>
  <span>pause</span>
  <span>lfence</span>
  <span>jmp</span> <span>.Lspec_trap_0</span>
<span>.Ldo_rop_0:</span>
  <span>mov</span> <span>[</span><span>rsp</span><span>],</span> <span>rax</span>
  <span>ret</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>…all of that to replace a simple <code>call [rax]</code>!</p>

<h3 id="consequences">Consequences</h3>

<p>There are repercussions for this kind of trickery:</p>

<ul>
  <li>
    <p>It’s slow when correctly predicted: we’ve replaced a single indirect <code>CALL</code> with at least two
direct <code>CALL</code>s, plus a <code>RET</code>.</p>
  </li>
  <li>
    <p>It’s <em>really</em> slow when mispredicted: we <em>literally</em> spin in place using <code>PAUSE</code> and <code>LFENCE</code>.</p>
  </li>
  <li>
    <p>It’s a ROP gadget, so it <em>looks</em> like an exploit primitive. That means it screws with Intel’s
<a href="https://software.intel.com/sites/default/files/managed/4d/2a/control-flow-enforcement-technology-preview.pdf">CET</a>
and similar protections on other platforms. Intel claims that newer hardware will support “enhanced
IBRS”<sup id="fnref:ibrs" role="doc-noteref"><a href="#fn:ibrs">7</a></sup> that will replace the …</p></li></ul></div>
<br/><p><em>Article truncated for RSS feed. Read the full article at <a href="https://blog.yossarian.net/2020/12/16/Static-calls-in-Linux-5-10">https://blog.yossarian.net/2020/12/16/Static-calls-in-Linux-5-10</a></em></p>]]>
            </description>
            <link>https://blog.yossarian.net/2020/12/16/Static-calls-in-Linux-5-10</link>
            <guid isPermaLink="false">hacker-news-small-sites-25453663</guid>
            <pubDate>Thu, 17 Dec 2020 08:13:13 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Show HN: Deep learning tool that repairs damaged/faded photos]]>
            </title>
            <description>
<![CDATA[
Score 79 | Comments 20 (<a href="https://news.ycombinator.com/item?id=25453481">thread link</a>) | @panabee
<br/>
December 16, 2020 | https://hotpot.ai/restore-picture?s=hn | <a href="https://web.archive.org/web/*/https://hotpot.ai/restore-picture?s=hn">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div id="rootBody">

		


		<div id="rootYield">
			




<div id="pageBox">

	


	<div id="mainBox">

		<div id="controlBox">

			<div>
				<p><img src="https://hotpot.ai/images/site/transparent.gif">
				</p>
			</div>

			

			<p><span>Restore</span>
			</p>

		</div>

		

	</div>


	<article id="apiAccess">
		<h2>API Access</h2>

		<p>
			Add this service to your app, website, or company workflow with the <a href="https://hotpot.ai/docs/api">Hotpot API</a>.
		</p>
	</article>

	


	<article>
		<h2>Directions</h2>

		<p>
			Upload an image.
		</p>

		<p>
			Enable "Has Scratches" to explicitly remove scratches.
		</p>

		<p>
			To turn black &amp; white pictures to color, try our AI <a href="https://hotpot.ai/colorize-picture?s=restorer">Picture Colorizer</a> service.
		</p>
	</article>


	<article>
		<h2>Overview</h2>

		<p>
			This Hotpot AI service restores pictures by automatically performing scratch removal, face enhancement, and color sharpening. What used to require trained professionals hours can now be accomplished in seconds.
		</p>

		<p>
			The service can repair and restore both color and black &amp; white photographs.
		</p>

		<p>
			While this service automates photo restoration, it cannot replace experts for demanding restoration jobs. It is designed to help consumers with lightweight requirements while helping professionals save time on difficult restoration requests.
		</p>

		<p>
			For this service, pictures are not saved without user permission. For storage costs and user privacy, we only retain images for as long as necessary to run our machine learning models, and do not store photos beyond this.
		</p>

		<p>
			Note: the maximum image resolution we support is 1280x1280, but our new model supports larger images and is launching soon. Please contact us to try this newer model.
		</p>
	</article>


	<article>
	<h2>AI Tools</h2>

	<p>
		Explore other Hotpot <a href="https://hotpot.ai/tools">AI tools</a>, including ones for <a href="https://hotpot.ai/remove-background">background removal</a>, <a href="https://hotpot.ai/personalize-art">art personalization</a>, <a href="https://hotpot.ai/enlarge-picture">image upscaler</a> for photo prints, <a href="https://hotpot.ai/restore-picture">picture restoration</a>, <a href="https://hotpot.ai/colorize-picture">picture colorization</a>, and more.
	</p>
</article>


	<article>
		<h2>Research Credit</h2>

		<p>
			Our technology applies proprietary enhancements to the amazing Microsoft research project, <a href="https://github.com/microsoft/Bringing-Old-Photos-Back-to-Life" target="_blank">Bringing Old Photos Back to Life</a>.
		</p>
	</article>


	<article>
		<h2>Contribute</h2>

		<p>
			Help improve our AI by <a href="https://hotpot.ai/contact">sharing images</a> that convert poorly.
		</p>
	</article>


</div>








<!---------------------------- Hotjar BEGIN ---------------------------->



<!---------------------------- Hotjar END ----------------------------->
		</div>

	</div></div>]]>
            </description>
            <link>https://hotpot.ai/restore-picture?s=hn</link>
            <guid isPermaLink="false">hacker-news-small-sites-25453481</guid>
            <pubDate>Thu, 17 Dec 2020 07:36:37 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Creative Code-Generated Art]]>
            </title>
            <description>
<![CDATA[
Score 131 | Comments 38 (<a href="https://news.ycombinator.com/item?id=25453252">thread link</a>) | @dzink
<br/>
December 16, 2020 | https://www.editorx.com/shaping-design/article/creative-coding | <a href="https://web.archive.org/web/*/https://www.editorx.com/shaping-design/article/creative-coding">archive.org</a>
<br/><!-- hnss:readable-content --><hr/>Unable to retrieve article]]>
            </description>
            <link>https://www.editorx.com/shaping-design/article/creative-coding</link>
            <guid isPermaLink="false">hacker-news-small-sites-25453252</guid>
            <pubDate>Thu, 17 Dec 2020 06:44:44 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[React's UseRef Deep Dive]]>
            </title>
            <description>
<![CDATA[
Score 67 | Comments 75 (<a href="https://news.ycombinator.com/item?id=25452146">thread link</a>) | @giovannibenussi
<br/>
December 16, 2020 | https://www.giovannibenussi.com/blog/a-complete-guide-to-useref/?id=1 | <a href="https://web.archive.org/web/*/https://www.giovannibenussi.com/blog/a-complete-guide-to-useref/?id=1">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div><article itemscope="" itemtype="http://schema.org/Article"><header></header><p><code>useRef</code> allows you to keep a mutable value within a component, similar to <code>useState</code> or instance variables on a class, without triggering re-renders.</p><p>For example, this component stores the number of clicks for a button:</p><div data-language="jsx"><pre><code><span>function</span> <span>RefButton</span> <span>(</span><span>)</span> <span>{</span>
  <span>const</span> clicks <span>=</span> <span>useRef</span><span>(</span><span>0</span><span>)</span>

  <span>return</span> <span>(</span>
    <span><span><span>&lt;</span>button</span> <span>onClick</span><span><span>=</span><span>{</span><span>(</span><span>)</span> <span>=&gt;</span> <span>(</span>clicks<span>.</span>current <span>+=</span> <span>1</span><span>)</span><span>}</span></span><span>&gt;</span></span><span>
      Clicks: </span><span>{</span>clicks<span>.</span>current<span>}</span><span>
    </span><span><span><span>&lt;/</span>button</span><span>&gt;</span></span>
  <span>)</span>
<span>}</span></code></pre></div><p>This is how this component looks like (I added a re-render button so you can
actually test it out 😄):</p><div><h2>Interactive Example</h2><p>The example below is completely interactive, try clicking the "Clicks" button and then click on "Re-render".</p></div><p>As you can see, if you click the "Clicks" button it doesn't do anything. However, after click on "Re-render", it gets updated with the number of clicks we did previously.</p><h2>Difference with a variable</h2><p>You might wonder why not just use a simple variable as the example below:</p><div data-language="jsx"><pre><code><span>let</span> clicks <span>=</span> <span>0</span><span>;</span>

<span>function</span> <span>OutsideVariableButton</span><span>(</span><span>)</span> <span>{</span>
  <span>return</span> <span>(</span>
    <span><span><span>&lt;</span>button</span> <span>onClick</span><span><span>=</span><span>{</span><span>(</span><span>)</span> <span>=&gt;</span> <span>(</span>clicks <span>+=</span> <span>1</span><span>)</span><span>}</span></span><span>&gt;</span></span><span>
      Clicks: </span><span>{</span>clicks<span>}</span><span>
    </span><span><span><span>&lt;/</span>button</span><span>&gt;</span></span>
  <span>)</span>
<span>}</span></code></pre></div><p>And here's an interactive example for it:</p><div><h2>Interactive Example</h2><p><strong>Type</strong><strong>Result</strong><span>outside variable</span></p></div><p>The button works the same way that our previous example. However, the problem arises when you have multiple instances of the same component like the example below. Try clicking just one of the buttons and then click on re-render to see the result.</p><div><h2>Interactive Example</h2><p><strong>Type</strong><strong>Result</strong><span>outside variable</span><span>outside variable</span><span>outside variable</span></p></div><p>As you were able to see, the clicks are not isolated. In fact, all the examples
from this article uses the same button component, so if you click the button
from the first example and then click on "re-render" on the second example, the count it is gonna be
incremented! What a bug 🐛.</p><p>On the other hand, <code>useRef</code> values are completely isolated between components:</p><div><h2>Interactive Example</h2><p><strong>Type</strong><strong>Result</strong><span>ref</span><span>ref</span><span>ref</span></p></div><h2>Difference with&nbsp;useState</h2><blockquote><p>The main difference between useState and useRef, is that useState triggers a
re-render and useRef doesn't.</p></blockquote><p>In the following example I added two buttons: one that updates its count with <code>useRef</code> and the other one with <code>useState</code>. I added some labels so you can identify them easily.</p><div><h2>Interactive Example</h2><p><strong>Type</strong><strong>Result</strong><span>state</span><span>ref</span></p></div><p>You'll notice that clicking on the button with <code>useRef</code> doesn't trigger a re-render and thus, the view isn't updated. On the other side, when you click on the button that uses <code>useState</code>, it will update its clicks count immediately.</p><p>To perform imperative actions on DOM nodes, React provides a way to get a
reference to them via refs. All you have to do is to assign a <code>ref</code> property to
a node with a ref object like this:</p><div data-language="jsx"><pre><code><span>function</span> <span>CustomInput</span><span>(</span><span>)</span> <span>{</span>
  <span>const</span> inputRef <span>=</span> <span>useRef</span><span>(</span><span>)</span>

  <span>return</span> <span><span><span>&lt;</span>input</span> <span>ref</span><span><span>=</span><span>{</span>inputRef<span>}</span></span> <span>/&gt;</span></span>
<span>}</span></code></pre></div><p>The way to get a DOM reference using refs works (informally 😅) as follows:</p><div><p><span>Today</span></p><div><p>React</p><p>Hey, what's up?<span>12:00</span></p></div><div><p>Could you give me a reference to this dom node?<span>12:00<svg style="color:#34B7F1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><svg style="color:#34B7F1;margin-left:-12px" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></span></p></div><div><p>React</p><p>Sure, I assigned it to the 'current' property of your ref.<span>12:00</span></p></div></div><p>On the first render, <code>inputRef</code>'s value will be <code>{ current: null }</code> and in the
following renders it will have its <code>current</code> property assigned to the specified DOM
node:</p><p>However, if you only reference <code>inputRef</code> inside <code>useEffect</code> then it'll always
reference the DOM node so you don't need to worry about it being undefined.</p><p>Let's update our example to get an idea of how this works:</p><div data-language="jsx"><pre><code><span>function</span> <span>AttachingToDomExample</span><span>(</span><span>)</span> <span>{</span>
  <span>const</span> inputRef <span>=</span> <span>useRef</span><span>(</span><span>)</span>

  console<span>.</span><span>log</span><span>(</span><span>"Render inputRef value:"</span><span>,</span> inputRef<span>)</span>

  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> console<span>.</span><span>log</span><span>(</span><span>"useEffect inputRef value:"</span><span>,</span> inputRef<span>)</span><span>)</span>

  <span>return</span> <span><span><span>&lt;</span>input</span> <span>ref</span><span><span>=</span><span>{</span>inputRef<span>}</span></span> <span>/&gt;</span></span>
<span>}</span></code></pre></div><p>Here's the console output when rendering this component:</p><table><thead><tr><th>Render</th><th>Location</th><th>Value</th></tr></thead><tbody><tr><td>1</td><td>Render</td><td>{ current: undefined }</td></tr><tr><td></td><td>useEffect</td><td>{ current: &lt;input /<!-- -->&gt;<!-- --> }</td></tr><tr><td>2</td><td>Render</td><td>{ current: &lt;input /<!-- -->&gt;<!-- --> }</td></tr><tr><td></td><td>useEffect</td><td>{ current: &lt;input /<!-- -->&gt;<!-- --> }</td></tr><tr><td>3</td><td>Render</td><td>{ current: &lt;input /<!-- -->&gt;<!-- --> }</td></tr><tr><td></td><td>useEffect</td><td>{ current: &lt;input /<!-- -->&gt;<!-- --> }</td></tr></tbody></table><p>As you can see, if you access the <code>inputRef</code> inside <code>useEffect</code> then you don't
need to worry about it being <code>undefined</code> because React will assign it
automatically for you.</p><p>Let's start with a simple real-world application for refs: <code>usePrevious</code>. This
hook stores the previous value for a given state variable.
<a href="https://reactjs.org/docs/hooks-faq.html#how-to-get-the-previous-props-or-state" target="_blank" rel="nofollow">It is even referenced on React's docs</a> as a way to "get the previous props or state". Let's see it in
action first:</p><div data-language="jsx"><pre><code><span>function</span> <span>UsePreviousExample</span><span>(</span><span>)</span> <span>{</span>
  <span>const</span> <span>[</span>clicks<span>,</span> setClicks<span>]</span> <span>=</span> <span>useState</span><span>(</span><span>0</span><span>)</span>
  
  <span>const</span> previousClicks <span>=</span> <span>usePrevious</span><span>(</span>clicks<span>)</span>

  <span>return</span> <span>(</span>
    <span><span><span>&lt;</span>div</span><span>&gt;</span></span><span>
      </span><span><span><span>&lt;</span>button</span> <span>onClick</span><span><span>=</span><span>{</span><span>(</span><span>)</span> <span>=&gt;</span> <span>setClicks</span><span>(</span>clicks <span>+</span> <span>1</span><span>)</span><span>}</span></span><span>&gt;</span></span><span>
        Clicks: </span><span>{</span>clicks<span>}</span><span> - Before: </span><span>{</span>previousClicks<span>}</span><span>
      </span><span><span><span>&lt;/</span>button</span><span>&gt;</span></span><span>
    </span><span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
  <span>)</span>
<span>}</span></code></pre></div><p>Here's the output so you can play with it:</p><p>You can notice that the <code>previousClicks</code> variable stores the value for the previous render
for a given variable. Here's its implementation:</p><div data-language="jsx"><pre><code><span>function</span> <span>usePrevious</span><span>(</span><span>value</span><span>)</span> <span>{</span>
  <span>const</span> ref <span>=</span> <span>useRef</span><span>(</span><span>)</span>
  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
    ref<span>.</span>current <span>=</span> value
  <span>}</span><span>)</span>
  <span>return</span> ref<span>.</span>current
<span>}</span></code></pre></div><p>Let's analyze how it works.</p><p>Let's simulate what happens on the first render. We can remove the call to
<code>useEffect</code> since it doesn't affect the return value on the first render:</p><div data-language="jsx"><pre><code>
<span>function</span> <span>usePrevious</span><span>(</span><span>value</span><span>)</span> <span>{</span>
  <span>const</span> ref <span>=</span> <span>useRef</span><span>(</span><span>)</span>
  <span>return</span> ref<span>.</span>current
<span>}</span></code></pre></div><p>On the first render it is called with a value of <code>0</code>:</p><div data-language="jsx"><pre><code>
<span>const</span> previousClicks <span>=</span> <span>usePrevious</span><span>(</span><span>0</span><span>)</span></code></pre></div><p>In this case, <code>usePrevious</code> will return <code>undefined</code>:</p><div data-language="jsx"><pre><code>
<span>function</span> <span>usePrevious</span><span>(</span><span>value</span><span>)</span> <span>{</span>
  <span>const</span> ref <span>=</span> <span>useRef</span><span>(</span><span>)</span>
  <span>return</span> ref<span>.</span>current 
<span>}</span></code></pre></div><p>After increase the value for count, here's how the <code>usePrevious</code> call will look:</p><div data-language="jsx"><pre><code>
<span>const</span> previousClicks <span>=</span> <span>usePrevious</span><span>(</span><span>1</span><span>)</span></code></pre></div><p>Since <code>usePrevious</code> is called again, its effect needs to run:</p><div data-language="jsx"><pre><code><span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=&gt;</span> <span>{</span>
  ref<span>.</span>current <span>=</span> <span>0</span>
<span>}</span><span>)</span></code></pre></div><p>After this, the <code>usePrevious</code> function is called again:</p><div data-language="jsx"><pre><code>
<span>function</span> <span>usePrevious</span><span>(</span><span>value</span><span>)</span> <span>{</span>
  <span>const</span> ref <span>=</span> <span>useRef</span><span>(</span><span>)</span>
  <span>return</span> ref<span>.</span>current 
<span>}</span></code></pre></div><p>And so on. Here's the value for each render for both variables:</p><table><thead><tr><th>Render</th><th>clicks</th><th>previousClicks</th></tr></thead><tbody><tr><td>1</td><td>0</td><td>undefined</td></tr><tr><td>2</td><td>1</td><td>0</td></tr><tr><td>3</td><td>2</td><td>1</td></tr><tr><td>4</td><td>3</td><td>2</td></tr></tbody></table><p>Callback Refs are a different way to set refs. It gives you a fine-grain control
over when refs are attached and detached because you provide a function instead
of a ref variable. This function gets called every time the component mounts and
unmounts.</p><p><a href="https://codesandbox.io/s/callback-ref-example-lqe8w?file=/src/App.js" target="_blank" rel="nofollow">Here's an example</a> that shows/hides an emoji every time you click its button.
The important thing here is the <code>ref</code> prop that we added. We use a function to log
the provided ref:</p><div data-language="jsx"><pre><code><span>const</span> <span>callback</span> <span>=</span> <span>(</span><span>ref</span><span>)</span> <span>=&gt;</span> console<span>.</span><span>log</span><span>(</span><span>"callback:"</span><span>,</span> ref<span>)</span>

<span>function</span> <span>App</span> <span>(</span><span>)</span> <span>{</span>
  <span>const</span> <span>[</span>show<span>,</span> setShow<span>]</span> <span>=</span> <span>useState</span><span>(</span><span>true</span><span>)</span><span>;</span>

  <span>return</span> <span>(</span>
    <span><span><span>&lt;</span>div</span><span>&gt;</span></span><span>
      </span><span><span><span>&lt;</span>button</span> <span>onClick</span><span><span>=</span><span>{</span><span>(</span><span>)</span> <span>=&gt;</span> <span>setShow</span><span>(</span><span>!</span>show<span>)</span><span>}</span></span><span>&gt;</span></span><span>
        </span><span>{</span>show <span>?</span> <span>"Hide"</span> <span>:</span> <span>"Show"</span><span>}</span><span>
      </span><span><span><span>&lt;/</span>button</span><span>&gt;</span></span><span>
      </span><span>{</span>show <span>&amp;&amp;</span> <span><span><span>&lt;</span>span</span> <span>ref</span><span><span>=</span><span>{</span>callback<span>}</span></span><span>&gt;</span></span><span>👋</span><span><span><span>&lt;/</span>span</span><span>&gt;</span></span><span>}</span><span>
    </span><span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
  <span>)</span><span>;</span>
<span>}</span></code></pre></div><p>Here's an interactive version of the previous code (you can check the output in
the console to see that I'm not lying 🙃):</p><p><em>Note: If you use callback refs as inline functions, it will be called
twice: one with <code>null</code> and another one with the DOM element.
This is because React needs to clear the previous ref every time the function is
created. A workaround for this is to use a class method.</em></p><div><h2>Warning</h2><p><a href="https://reactjs.org/docs/refs-and-the-dom.html#legacy-api-string-refs" target="_blank" rel="nofollow">String refs</a> are a legacy feature and they are likely to be removed in future React versions.</p></div><p>The way it works is that you provide a string as a ref value like <code>ref="exampleRef"</code> and it automatically gets assigned to <code>this.refs</code>.</p><p><em>Note: String refs can only be used with class components.</em></p><p>Here's an usage example:</p><div data-language="jsx"><pre><code><span>export</span> <span>default</span> <span>class</span> <span>App</span> <span>extends</span> <span>React<span>.</span>Component</span> <span>{</span>
  <span>render</span><span>(</span><span>)</span> <span>{</span>
    console<span>.</span><span>log</span><span>(</span><span>this</span><span>.</span>refs<span>)</span><span>;</span>

    <span>return</span> <span>(</span>
      <span><span><span>&lt;</span>div</span> <span>ref</span><span><span>=</span><span>"</span>exampleRef<span>"</span></span><span>&gt;</span></span><span>
        </span><span><span><span>&lt;</span>button</span> <span>onClick</span><span><span>=</span><span>{</span><span>(</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>setState</span><span>(</span><span>{</span> dummy<span>:</span> <span>0</span> <span>}</span><span>)</span><span>}</span></span><span>&gt;</span></span><span>Re-render</span><span><span><span>&lt;/</span>button</span><span>&gt;</span></span><span>
      </span><span><span><span>&lt;/</span>div</span><span>&gt;</span></span>
    <span>)</span><span>;</span>
  <span>}</span>
<span>}</span></code></pre></div><p>Here's the value for <code>this.refs</code> across renders:</p><table><thead><tr><th>Render</th><th>this.refs</th></tr></thead><tbody><tr><td>1</td><td><code>{}</code></td></tr><tr><td>2</td><td><code>{ exampleRef: &lt;div&gt;...&lt;/div&gt; }</code></td></tr><tr><td>3</td><td><code>{ exampleRef: &lt;div&gt;...&lt;/div&gt; }</code></td></tr><tr><td>4</td><td><code>{ exampleRef: &lt;div&gt;...&lt;/div&gt; }</code></td></tr></tbody></table><p>As you can see, on the first render <code>this.refs.exampleRef</code> will be undefined and
on the following renders it will point out to the specified DOM node.</p><p>We saw what <code>useRef</code> is, how it differentiates with a plain old variable and
state variables, and we saw real world examples that uses it. I hope that most
of the content makes sense to you!</p><p>I'd love to hear your feedback. You can <a href="https://twitter.com/giovannibenussi" target="_blank" rel="nofollow">reach out to me on
Twitter</a> at any time :-)</p><hr></article></div></div>]]>
            </description>
            <link>https://www.giovannibenussi.com/blog/a-complete-guide-to-useref/?id=1</link>
            <guid isPermaLink="false">hacker-news-small-sites-25452146</guid>
            <pubDate>Thu, 17 Dec 2020 03:36:51 GMT</pubDate>
        </item>
    </channel>
</rss>
