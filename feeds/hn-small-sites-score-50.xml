<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>
<![CDATA[Hacker News - Small Sites - Score >= 50]]>
        </title>
        <description>
<![CDATA[Hacker News stories from domains that aren't in the top 1M and that have a score of at least 50. Updated nightly via https://github.com/awendland/hacker-news-small-sites]]>
        </description>
        <link>https://news.ycombinator.com</link>
        <generator>RSS for Node</generator>
        <lastBuildDate>Thu, 08 Oct 2020 12:34:30 GMT</lastBuildDate>
        <atom:link href="https://raw.githubusercontent.com/awendland/hacker-news-small-sites/generated/feeds/hn-small-sites-score-50.xml" rel="self" type="application/rss+xml"></atom:link>
        <pubDate>Thu, 08 Oct 2020 12:34:30 GMT</pubDate>
        <language>
<![CDATA[en-US]]>
        </language>
        <managingEditor>
<![CDATA[me@alexwendland.com (Alex Wendland)]]>
        </managingEditor>
        <ttl>240</ttl>
        <item>
            <title>
<![CDATA[Fooling Around with Foveated Rendering]]>
            </title>
            <description>
<![CDATA[
Score 82 | Comments 34 (<a href="https://news.ycombinator.com/item?id=24695275">thread link</a>) | @underanalyzer
<br/>
October 5, 2020 | https://www.peterstefek.me/focused-render.html | <a href="https://web.archive.org/web/*/https://www.peterstefek.me/focused-render.html">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div>
 <div>
  
  <p><label>Posted on <strong>28 September 2020</strong></label></p>
<p>Shadertoy is a wonderful tool which lets users create and share a type of program called a fragment shader online. The true magic of shadertoy is its community of very talented graphics programmers who build incredible works of art despite having access to only a sliver of the traditional graphics pipeline.  </p>
<p>Some of these shaders are very computationally intensive and even in a small window, they crawl along well below their intended 60 frames per second on my old laptop. Inspired by a technique in the VR community called Foveated Rendering, I decided to try to optimize these shaders by only rendering a fully detailed image within a small focal region. As you move away from the focal point the image quality decreases.   </p>
<p>This rendering scheme is motivated by biology. It turns out your eye notices more detail in the center of your vision than in the periphery. Some VR graphics programmers realized they could take advantage of this phenomenon to increase the effective resolution of images by increasing image quality towards the center of your vision. An in depth discussion of foveated rendering can be found in the “previous work section” of this <a href="https://ai.facebook.com/blog/deepfovea-using-deep-learning-for-foveated-reconstruction-in-ar-vr">paper</a>.  </p>
<p>I did not have the time, equipment or the background necessary to implement a full foveated rendering system but it was fun to fool around with the concept.  </p>
<p>Before diving into the technical details let’s look at a simple shadertoy fragment shader.   </p>
<p><code>
void mainImage(out vec4 fragColor, in vec2 fragCoord)<br>
{
</code></p><p><code>
    // Normalized pixel coordinates (from 0 to 1)<br>
    vec2 uv = fragCoord/iResolution.xy;
<div><pre><span></span><span>//</span> <span>Output</span> <span>the</span> <span>pixel</span> <span>coordinates</span> <span>as</span> <span>a</span> <span>color</span> <span>to</span> <span>screen</span>
<span>//</span> <span>fragColor</span> <span>is</span> <span>a</span> <span>4</span> <span>vector</span> <span>of</span> <span>the</span> <span>form</span>
<span>//</span> <span>(</span><span>red</span><span>,</span> <span>green</span><span>,</span> <span>blue</span><span>,</span> <span>transparency</span><span>)</span>
<span>fragColor</span> <span>=</span> <span>vec4</span><span>(</span><span>uv</span><span>,</span> <span>0</span><span>.</span><span>0</span><span>,</span> <span>1</span><span>.</span><span>0</span><span>);</span>
</pre></div>


</code></p><p><code>
}<br>
</code></p>
<p>This program runs once for each pixel on the screen. Each time it runs, we receive the input variable <code>fragCoord</code>. <code>fragCoord</code> is a 2d vector which contains the x and y coordinates of the pixel being drawn. We normalize those coordinates by dividing by <code>iResolution</code>, another 2d vector, which contains the width and height of the image. Finally we output a color to the screen, whose red and green channels are proportional to the x and y position of the pixel being drawn. The output of this shader looks like this:<br>
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/simple-shader-out.png" width="50%"> 
</p>
<p>Side note, why do these shader programs require their own language? Shaders are special because they run on the graphics card instead of the cpu. They are highly parallel. A helpful mental model might be imagining that each pixel is colored simultaneously. Therefore a lot of things that we take for granted in normal program languages such as liberally accessing memory and branching become much more difficult.  </p>
<p>In shadertoy shaders the bottleneck is always in the pixel rendering step. So to speed them up we want to only render a subset of the all the pixels on the screen. It seems like selectively rendering pixels should be as simple as adding a branch to the per pixel shader code that looks like:  </p>
<p><code>
void mainImage(out vec4 fragColor, in vec2 fragCoord) <br>
{<br>
</code></p><p><code>
    if (fragCoord is in the subset of pixels to render) {
      <p>
      ... do computationally intensive work 
      </p> 
    } else {
      <p>
      // return a black pixel<br>
      return vec4(0, 0, 0, 1); 
      </p> 
    } 
</code></p><p><code> 
}
</code></p>
<p>Unfortunately we cannot just use an if statement inside of the shader to save us from rendering all the pixels. Unlike normal programming languages, fragment shaders always execute both parts of each branch due to gpu limitations. So while our above code will still have to spend the sample amount of time evaluating compuationally intensive work.  </p>
<p>Luckily, it turns out that graphics drivers can selectively mark which pixels not to shade by writing their location to a special buffer called the stencil buffer. We can use this stencil buffer to only shade the subset of pixels we are interested in.</p>
<p>Once I could efficiently render a subset of the pixels, I needed to come up with a pre-generated sampling pattern. Most foveated rendering techniques seem to use a grid, but I decided to try a non uniform approach. Searching for some kind of optimal sampling pattern seemed like an interesting problem and if I was going to devote more time to this I'd explore options like <a href="https://blog.demofox.org/2018/01/30/what-the-heck-is-blue-noise/">blue noise</a>. However in the interest of time, I just decided fill in a small circle in the center and then use samples drawn from one low variance and one high variance gaussians centered at the middle of the screen to place the rest of the pixels. The final sampling pattern ended up looking like this:
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/final-sample-pattern.png" width="50%"> 
</p>
<p>Next, I needed a way to fill in all the missing pixels in the final image. The approach I took was pretty simple. I started by mapping each pixel in the final screen to its nearest neighbor. Since my sampling pattern was predetermined, I could create this map beforehand and pass it into the shader as a texture. Here's what this mapping looks like:<br>
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/nearest-mapping.png" width="50%"> 
</p>
<p>And here’s a gif of the mapping applied to a <a href="https://www.shadertoy.com/view/3lsSzf">shadertoy</a> created by the extremely talented <a href="https://www.iquilezles.org/">Inigo Quilez</a>:<br>
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/1-neighbor.gif"> 
</p>
<p>The above screen is 420x236 pixels and only 1/10th of those pixels are actually rendered. The focal point is directly in the center of the screen. Here's what the full resolution version looks like:</p>
<p>
  <img src="https://www.peterstefek.me/images/focused-render/original.gif"> 
</p>

<p>And here's what it looks like with only our sampling pixels:
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/sample-pixels.gif"> 
</p>
<p>One little improvement I tried was to make 4 different maps. The kth map mapped each pixel in the final image to its kth nearest sampled neighbor. I weighted each of neighbors by the inverse of their distance to the pixel in question. I actually even tried using some gradient descent based optimization to fine tune the weights but ended up seeing little improvement. It also seemed that increasing the number of maps beyond 4 did not improve things much either. Here's what the example from above looks like with weighted interpolation between the four closest neighbors of each pixel (we are still rendering only 1/10th of the total pixels):
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/4-neighbors.gif"> 
</p>
<p>Finally, here's the shader with 1/5th of the total pixels rendered (as opposed to 1/10th shown above):
</p><p>
  <img src="https://www.peterstefek.me/images/focused-render/1of5pixels.gif"> 
</p>
<p>Okay that's all cool but does this technique actually increase performance? I did not do a rigerous benchmark, but <a href="https://www.shadertoy.com/view/3l23Rh">this shader</a> goes from around 20-25 fps on my plugged in laptop to 60 fps when reduced to 1/5th of the total pixels. <a href="https://www.shadertoy.com/view/Ms2SD1">Another shader</a> went from around 15 fps to 60 fps.  </p>
<p>One last side note is that this method can be used with any 3d scene and is not exclusive to shader toys. I just chose to use them because they are always bottlenecked by the pixel rendering step and they are really pretty!</p>
<p>Further questions:</p>
<ul>
<li>How do we achive better temporal stability? (the <a href="https://ai.facebook.com/blog/deepfovea-using-deep-learning-for-foveated-reconstruction-in-ar-vr">paper</a> I mentioned earlier talks about this)</li>
<li>Can we dynamically change the sampling pattern to give us better results? For example what if we sampled along edges or areas where large amounts of motion is occuring? Of course to do this we would need to compute our nearest neighbor mappings on the fly (there are actually <a href="https://www.shadertoy.com/view/XtlGDS">some</a> <a href="https://www.shadertoy.com/view/ldl3W8">shadertoys</a> which already demonstrate capability).</li>
<li>How could this scheme improve if we had access to the internals of the 3d scene? For example, could we adjust our sampling pattern based on depth information?  </li>
<li>How does this actually look in VR?  </li>
</ul>
<p>Have questions / comments / corrections?<br>
Get in touch: <a href="mailto:pstefek.dev@gmail.com">pstefek.dev@gmail.com</a>   </p>
<p>Discussion on <a href="https://news.ycombinator.com/item?id=24695275">Hacker News</a></p>
 </div>
</div></div>]]>
            </description>
            <link>https://www.peterstefek.me/focused-render.html</link>
            <guid isPermaLink="false">hacker-news-small-sites-24695275</guid>
            <pubDate>Tue, 06 Oct 2020 06:44:24 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[.NET Orleans]]>
            </title>
            <description>
<![CDATA[
Score 260 | Comments 222 (<a href="https://news.ycombinator.com/item?id=24691500">thread link</a>) | @swyx
<br/>
October 5, 2020 | http://dotnet.github.io/orleans/ | <a href="https://web.archive.org/web/*/http://dotnet.github.io/orleans/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div role="main">
        <div>
          <div>
            <article id="_content" data-uid="">

<p>
  <img src="https://raw.githubusercontent.com/dotnet/orleans/gh-pages/assets/logo_full.png" alt="Orleans logo" width="600px">
</p><p><a href="http://www.nuget.org/profiles/Orleans"><img src="https://img.shields.io/nuget/v/Microsoft.Orleans.Core.svg?style=flat" alt="NuGet"></a>
<a href="https://gitter.im/dotnet/orleans?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Gitter"></a></p>
<h3 id="orleans-is-a-cross-platform-framework-for-building-robust-scalable-distributed-applications">Orleans is a cross-platform framework for building robust, scalable distributed applications</h3>
<p>Orleans builds on the developer productivity of .NET and brings it to the world of distributed applications, such as cloud services. Orleans scales from a single on-premises server to globally distributed, highly-available applications in the cloud.</p>
<p>Orleans takes familiar concepts like objects, interfaces, async/await, and try/catch and extends them to multi-server environments. As such, it helps developers experienced with single-server applications transition to building resilient, scalable cloud services and other distributed applications. For this reason, Orleans has often been referred to as "Distributed .NET".</p>
<p>It was created by <a href="http://research.microsoft.com/projects/orleans/">Microsoft Research</a> and introduced the <a href="http://research.microsoft.com/apps/pubs/default.aspx?id=210931">Virtual Actor Model</a> as a novel approach to building a new generation of distributed systems for the Cloud era. The core contribution of Orleans is its programming model which tames the complexity inherent to highly-parallel distributed systems without restricting capabilities or imposing onerous constraints on the developer.</p>
<p>Documentation is located <a href="http://dotnet.github.io/orleans/Documentation/index.html">here</a></p>
</article>
          </div>
          
          
        </div>
      </div></div>]]>
            </description>
            <link>http://dotnet.github.io/orleans/</link>
            <guid isPermaLink="false">hacker-news-small-sites-24691500</guid>
            <pubDate>Mon, 05 Oct 2020 20:12:26 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Type-Level Programming in Rust]]>
            </title>
            <description>
<![CDATA[
Score 128 | Comments 26 (<a href="https://news.ycombinator.com/item?id=24687685">thread link</a>) | @fanf2
<br/>
October 5, 2020 | https://willcrichton.net/notes/type-level-programming/ | <a href="https://web.archive.org/web/*/https://willcrichton.net/notes/type-level-programming/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div>
  
  
  <p>
    
    Will Crichton
    
    &nbsp; — &nbsp;
    April 24, 2020
  </p>
  <p>I show how two domain-specific type systems, information flow control and two-party communication protocols, can be implemented in Rust using type-level programming. I explain how interesting properties of these domains can be verified at compile-time. Finally, I construct a general correspondence between type operators, logic programs, and their encoding in Rust.</p>
  <p>Typestate is the concept of encoding state machines in a programming language’s type system. While not specific to Rust, typestate has been <a href="http://cs242.stanford.edu/f19/lectures/08-2-typestate">explored</a> <a href="https://yoric.github.io/post/rust-typestate/">elsewhere</a> <a href="https://blog.systems.ethz.ch/blog/2018/a-hammer-you-can-only-hold-by-the-handle.html">at length</a> in the context of Rust. Typestate boils down to four ideas:</p>

<ol>
  <li>Each state is represented as a unique type.</li>
  <li>State transitions are only available as methods for the corresponding state type.</li>
  <li>Taking a state transition returns a state machine of the new state type.</li>
  <li>State transitions invalidate old state.</li>
</ol>

<p>For example, here’s a state machine for a send-then-receive channel:</p>

<div><div><pre><code><span>// Each state is a unique type</span>
<span>struct</span> <span>Receiving</span><span>;</span>
<span>struct</span> <span>Sending</span><span>;</span>

<span>// The state machine is parameterized by the state</span>
<span>#[repr(transparent)]</span>
<span>struct</span> <span>Channel</span><span>&lt;</span><span>State</span><span>&gt;</span> <span>{</span>
  <span>chan</span><span>:</span> <span>...</span><span>,</span>
  <span>_</span><span>state</span><span>:</span> <span>PhantomData</span><span>&lt;</span><span>State</span><span>&gt;</span>
<span>}</span>


<span>// Methods for the state are uniquely associated with only the state</span>
<span>impl</span> <span>Channel</span><span>&lt;</span><span>Receiving</span><span>&gt;</span> <span>{</span>
  <span>// recv consumes ownership, ensuring old state is invalidated</span>
  <span>fn</span> <span>recv</span><span>(</span><span>mut</span> <span>self</span><span>)</span> <span>-&gt;</span> <span>(</span><span>Channel</span><span>&lt;</span><span>Sending</span><span>&gt;</span><span>,</span> <span>String</span><span>)</span> <span>{</span>
    <span>let</span> <span>msg</span> <span>=</span> <span>self</span><span>.chan</span><span>.recv</span><span>();</span>
    <span>// The state type changes after executing a transition</span>
    <span>(</span><span>unsafe</span> <span>{</span> <span>transmute</span><span>(</span><span>self</span><span>)</span> <span>},</span> <span>msg</span><span>)</span>
  <span>}</span>
<span>}</span>

<span>impl</span> <span>Channel</span><span>&lt;</span><span>Sending</span><span>&gt;</span> <span>{</span>
  <span>fn</span> <span>send</span><span>(</span><span>mut</span> <span>self</span><span>,</span> <span>msg</span><span>:</span> <span>String</span><span>)</span> <span>-&gt;</span> <span>Channel</span><span>&lt;</span><span>Receiving</span><span>&gt;</span> <span>{</span>
    <span>self</span><span>.chan</span><span>.send</span><span>(</span><span>msg</span><span>);</span>
    <span>unsafe</span> <span>{</span> <span>transmute</span><span>(</span><span>self</span><span>)</span> <span>}</span>
  <span>}</span>
<span>}</span>

<span>#[test]</span>
<span>fn</span> <span>channel_test</span><span>()</span> <span>{</span>
  <span>let</span> <span>c</span><span>:</span> <span>Channel</span><span>&lt;</span><span>Sending</span><span>&gt;</span> <span>=</span> <span>Channel</span><span>::</span><span>new</span><span>();</span>
  <span>let</span> <span>c</span><span>:</span> <span>Channel</span><span>&lt;</span><span>Receiving</span><span>&gt;</span> <span>=</span> <span>c</span><span>.send</span><span>(</span><span>"hi"</span><span>);</span>
  <span>let</span> <span>(</span><span>c</span><span>,</span> <span>msg</span><span>)</span> <span>=</span> <span>c</span><span>.recv</span><span>();</span>
  <span>// and so on</span>
<span>}</span>
</code></pre></div></div>

<blockquote>
  <p>There are <a href="https://news.ycombinator.com/item?id=24688233">many</a> <a href="https://www.reddit.com/r/rust/comments/gaxlm3/typelevel_programming_in_rust/fp2gjhg/">readers</a> concerned with the use of <code>transmute</code>. The use of <code>#[repr(transparent)]</code> ensures that the layout of <code>Channel</code> is <a href="https://doc.rust-lang.org/nomicon/other-reprs.html#reprtransparent">stable across transmutations</a> of the marker type.</p>
</blockquote>

<p>This pattern works effectively for simple finite state machines, where the logic to determine the next state is straightforward. In this note, I will explore situations where determining the next state is not so simple. In the process, we’ll talk about <strong>type-level programming</strong>, or how you can use Rust’s type system to encode <strong>computations on types</strong>.</p>

<blockquote>
  <p>Part of the goal of this note is to show the value of type-level programming in practice. These same mechanisms have already been used for more esoteric purposes like <a href="https://sdleffler.github.io/RustTypeSystemTuringComplete/">showing Rust’s type system is Turing complete</a>, but I think type-level programming can really help us design better systems!</p>
</blockquote>

<h2 id="1-information-flow-control">1. Information flow control</h2>

<p>As a first example, consider a basic information flow control problem. In our program we have low security values (anyone can read them) and high security values (only authorized users can read them).</p>

<p>We represent this idea like so:</p>

<div><div><pre><code><span>// Each security level is a type</span>
<span>struct</span> <span>HighSec</span><span>;</span>
<span>struct</span> <span>LowSec</span><span>;</span>

<span>// An Item wraps an arbitrary type T, associating it with a Level</span>
<span>#[repr(transparent)]</span>
<span>struct</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>Level</span><span>&gt;</span> <span>{</span>
  <span>t</span><span>:</span> <span>Box</span><span>&lt;</span><span>T</span><span>&gt;</span><span>,</span>
  <span>_</span><span>marker</span><span>:</span> <span>PhantomData</span><span>&lt;</span><span>Level</span><span>&gt;</span>
<span>}</span>

<span>// Constructors for building items of a particular security</span>
<span>impl</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>LowSec</span><span>&gt;</span> <span>{</span>
  <span>pub</span> <span>fn</span> <span>low_sec</span><span>(</span><span>t</span><span>:</span> <span>T</span><span>)</span> <span>-&gt;</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>LowSec</span><span>&gt;</span> <span>{</span>
    <span>Item</span> <span>{</span> <span>t</span><span>:</span> <span>Box</span><span>::</span><span>new</span><span>(</span><span>t</span><span>),</span> <span>_</span><span>marker</span><span>:</span> <span>PhantomData</span> <span>}</span>
  <span>}</span>

  <span>pub</span> <span>fn</span> <span>high_sec</span><span>(</span><span>t</span><span>:</span> <span>T</span><span>)</span> <span>-&gt;</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>HighSec</span><span>&gt;</span> <span>{</span>
    <span>Item</span> <span>{</span> <span>t</span><span>:</span> <span>Box</span><span>::</span><span>new</span><span>(</span><span>t</span><span>),</span> <span>_</span><span>marker</span><span>:</span> <span>PhantomData</span> <span>}</span>
  <span>}</span>
<span>}</span>

<span>// For simplicity, a naked Item can be read by anyone</span>
<span>impl</span><span>&lt;</span><span>T</span><span>,</span> <span>Level</span><span>&gt;</span> <span>Deref</span> <span>for</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>Level</span><span>&gt;</span> <span>{</span>
  <span>type</span> <span>Target</span> <span>=</span> <span>T</span><span>;</span>
  <span>fn</span> <span>deref</span><span>(</span><span>&amp;</span><span>self</span><span>)</span> <span>-&gt;</span> <span>&amp;</span><span>T</span> <span>{</span>
    <span>&amp;</span><span>self</span><span>.t</span>
  <span>}</span>
<span>}</span>

</code></pre></div></div>

<p>We would like to have a vector of these items with the following property:</p>
<ul>
  <li>If all of the items are low security, anyone can read any item.</li>
  <li>If any of the items are high security, only an authorized user can read any item.</li>
</ul>

<p>For example, our vector should pass this test:</p>

<div><div><pre><code><span>let</span> <span>v</span> <span>=</span> <span>SecureVec</span><span>::</span><span>new</span><span>();</span>
<span>let</span> <span>lo</span> <span>=</span> <span>Item</span><span>::</span><span>low_sec</span><span>(</span><span>1</span><span>);</span>
<span>let</span> <span>hi</span> <span>=</span> <span>Item</span><span>::</span><span>high_sec</span><span>(</span><span>2</span><span>);</span>
<span>let</span> <span>v</span> <span>=</span> <span>v</span><span>.push</span><span>(</span><span>lo</span><span>);</span>         <span>// v is still low sec</span>
<span>assert_eq!</span><span>(</span><span>*</span><span>v</span><span>.get</span><span>(</span><span>0</span><span>),</span> <span>1</span><span>);</span>   <span>// ok to read v</span>

<span>let</span> <span>v</span> <span>=</span> <span>v</span><span>.push</span><span>(</span><span>hi</span><span>);</span>         <span>// v is now high sec</span>
<span>// assert_eq!(v.get(0), 1); // can't read any more, compiler error</span>

<span>let</span> <span>w</span> <span>=</span> <span>HighSecWitness</span><span>::</span><span>login</span><span>();</span>
<span>assert_eq!</span><span>(</span><span>*</span><span>v</span><span>.get_secure</span><span>(</span><span>1</span><span>,</span> <span>w</span><span>),</span> <span>2</span><span>);</span> <span>// can read after login</span>
</code></pre></div></div>

<p>A basic type-state attempt looks like this. We can create and read a low-security vector:</p>

<div><div><pre><code><span>#[repr(transparent)]</span>
<span>struct</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>Level</span><span>&gt;</span> <span>{</span>
  <span>items</span><span>:</span> <span>Vec</span><span>&lt;</span><span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>Level</span><span>&gt;&gt;</span><span>,</span>
  <span>_</span><span>marker</span><span>:</span> <span>PhantomData</span><span>&lt;</span><span>Level</span><span>&gt;</span>
<span>}</span>

<span>impl</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>LowSec</span><span>&gt;</span> <span>{</span>
  <span>pub</span> <span>fn</span> <span>new</span><span>()</span> <span>-&gt;</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>LowSec</span><span>&gt;</span> <span>{</span>
    <span>SecureVec</span> <span>{</span> <span>items</span><span>:</span> <span>Vec</span><span>::</span><span>new</span><span>(),</span> <span>_</span><span>marker</span><span>:</span> <span>PhantomData</span> <span>}</span>
  <span>}</span>

  <span>pub</span> <span>fn</span> <span>get</span><span>(</span><span>&amp;</span><span>self</span><span>,</span> <span>i</span><span>:</span> <span>usize</span><span>)</span> <span>-&gt;</span> <span>&amp;</span><span>T</span> <span>{</span>
    <span>&amp;</span><span>self</span><span>.items</span><span>[</span><span>i</span><span>]</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>And we can protect a high-security vector through a witness:</p>

<div><div><pre><code><span>struct</span> <span>HighSecWitness</span><span>;</span>
<span>impl</span> <span>HighSecWitness</span> <span>{</span>
  <span>// sprinkle some high-security authentication in here...</span>
  <span>pub</span> <span>fn</span> <span>login</span><span>()</span> <span>-&gt;</span> <span>HighSecWitness</span> <span>{</span> <span>HighSecWitness</span> <span>}</span>
<span>}</span>


<span>impl</span><span>&lt;</span><span>T</span><span>&gt;</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>HighSec</span><span>&gt;</span> <span>{</span>
  <span>pub</span> <span>fn</span> <span>get_secure</span><span>(</span><span>&amp;</span><span>self</span><span>,</span> <span>i</span><span>:</span> <span>usize</span><span>,</span> <span>_</span><span>witness</span><span>:</span> <span>HighSecWitness</span><span>)</span> <span>-&gt;</span> <span>&amp;</span><span>T</span> <span>{</span>
    <span>&amp;</span><span>self</span><span>.items</span><span>[</span><span>i</span><span>]</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Now, to the main idea: how can we implement <code>push</code>? There are four possible state combinations: a high/low security vector with a high/low security item. While we can implement each combination as a separate method, it’s simpler to consider the underlying logic. <code>push</code> should return a vector of level <code>max(vec_level, item_level)</code> where <code>max(hi, lo) = hi</code>.</p>

<p>Our goal is to encode <code>max</code> as a <em>type-level computation</em>, i.e. an operator on types. The high-level idea:</p>
<ul>
  <li>Traits definitions are function signatures from types to types.</li>
  <li>Trait type parameters represent inputs and associated types represent outputs.</li>
  <li>Trait implementations define individual mappings from inputs to outputs.</li>
</ul>

<p>Here are those ideas in action to compute the max security level:</p>

<div><div><pre><code><span>// Self (implicitly) is the left operand, Other is the right operand,</span>
<span>// and Output is the output</span>
<span>trait</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>Other</span><span>&gt;</span> <span>{</span>
  <span>type</span> <span>Output</span><span>;</span>
<span>}</span>

<span>// These impls define the core computation</span>
<span>impl</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>LowSec</span><span>&gt;</span>  <span>for</span> <span>LowSec</span>  <span>{</span> <span>type</span> <span>Output</span> <span>=</span> <span>LowSec</span><span>;</span>  <span>}</span>
<span>impl</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>HighSec</span><span>&gt;</span> <span>for</span> <span>LowSec</span>  <span>{</span> <span>type</span> <span>Output</span> <span>=</span> <span>HighSec</span><span>;</span> <span>}</span>
<span>impl</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>LowSec</span><span>&gt;</span>  <span>for</span> <span>HighSec</span> <span>{</span> <span>type</span> <span>Output</span> <span>=</span> <span>HighSec</span><span>;</span> <span>}</span>
<span>impl</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>HighSec</span><span>&gt;</span> <span>for</span> <span>HighSec</span> <span>{</span> <span>type</span> <span>Output</span> <span>=</span> <span>HighSec</span><span>;</span> <span>}</span>

<span>// The type alias gives us a more convenient way to "call" the type operator</span>
<span>type</span> <span>MaxLevel</span><span>&lt;</span><span>L</span><span>,</span> <span>R</span><span>&gt;</span> <span>=</span> <span>&lt;</span><span>L</span> <span>as</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>R</span><span>&gt;&gt;</span><span>::</span><span>Output</span><span>;</span>
</code></pre></div></div>

<blockquote>
  <p>The most confusing part is the <code>MaxLevel</code> alias. In brief: <code>L as ComputeMaxLevel&lt;R&gt;</code> says “treat <code>L</code> as the trait object <code>ComputeMaxLevel&lt;R&gt;</code>”. This is necessary since multiple computation traits may have associated <code>Output</code> with <code>L</code>, so the explicit cast disambiguates the <code>MaxLevel</code> computation from the rest.</p>
</blockquote>

<p>Here’s an example of using the type operator:</p>

<div><div><pre><code><span>let</span> <span>_</span> <span>:</span> <span>MaxLevel</span><span>&lt;</span><span>HighSec</span><span>,</span> <span>LowSec</span><span>&gt;</span> <span>=</span> <span>HighSec</span><span>;</span> <span>// ok</span>
<span>let</span> <span>_</span> <span>:</span> <span>MaxLevel</span><span>&lt;</span><span>LowSec</span> <span>,</span> <span>LowSec</span><span>&gt;</span> <span>=</span> <span>LowSec</span><span>;</span>  <span>// ok</span>
<span>let</span> <span>_</span> <span>:</span> <span>MaxLevel</span><span>&lt;</span><span>LowSec</span> <span>,</span> <span>LowSec</span><span>&gt;</span> <span>=</span> <span>HighSec</span><span>;</span> <span>// type error</span>
</code></pre></div></div>

<p>Now, we can implement <code>SecureVec::push</code> in one method:</p>

<div><div><pre><code><span>impl</span><span>&lt;</span><span>T</span><span>,</span> <span>VecLevel</span><span>&gt;</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>VecLevel</span><span>&gt;</span> <span>{</span>
  <span>pub</span> <span>fn</span> <span>push</span><span>&lt;</span><span>ItemLevel</span><span>&gt;</span><span>(</span>
    <span>mut</span> <span>self</span><span>,</span>
    <span>t</span><span>:</span> <span>Item</span><span>&lt;</span><span>T</span><span>,</span> <span>ItemLevel</span><span>&gt;</span><span>,</span>
  <span>)</span> <span>-&gt;</span> <span>SecureVec</span><span>&lt;</span><span>T</span><span>,</span> <span>MaxLevel</span><span>&lt;</span><span>ItemLevel</span><span>,</span> <span>VecLevel</span><span>&gt;&gt;</span>
  <span>where</span>
    <span>ItemLevel</span><span>:</span> <span>ComputeMaxLevel</span><span>&lt;</span><span>VecLevel</span><span>&gt;</span><span>,</span>
  <span>{</span>
    <span>unsafe</span> <span>{</span>
      <span>self</span><span>.items</span><span>.push</span><span>(</span><span>transmute</span><span>(</span><span>t</span><span>));</span>
      <span>transmute</span><span>(</span><span>self</span><span>)</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Notice the usage of <code>MaxLevel</code> in the return type of <code>push</code>. This is the key use of the type operator as a type-level computation. The other main component is the <code>where</code> clause: when used generically (over any possible <code>ItemLevel</code>), we have to use a trait bound to ensure that <code>ComputeMaxLevel</code> can be “called” on <code>ItemLevel</code>.</p>

<p>Excellent! We’ve now used a type-level computation to more abstractly specify typestate in our information flow control API. Next, we’ll look at an example with a more complex type-level program.</p>

<h2 id="2-two-party-communication-protocols">2. Two-party communication protocols</h2>

<p>When two parties synchronously communicate with each other (e.g. a client and server exchanging information), that communication protocol can be modeled as a session type. We’re going to look at session types <a href="https://munksgaard.me/papers/laumann-munksgaard-larsen.pdf">implemented in Rust</a>. While their full implementation is beyond the scope of the post (see the linked paper or my <a href="http://cs242.stanford.edu/f19/lectures/09-1-session-types">course notes</a>), I will focus on the aspects of session types that showcase type-level programming.</p>

<p>Session types are a domain-specific language of state machines, described by this grammar:</p>



<p>For example, this session type describes a ping server that sends and receives a ping in a loop, exiting on demand. The label/goto scheme uses <a href="https://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> to locally encode label names as integers.</p>



<p>The grammar, and this example, can be encoded in Rust like so:</p>

<div><div><pre><code><span>struct</span> <span>Send</span><span>&lt;</span><span>T</span><span>,</span> <span>S</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>(</span><span>T</span><span>,</span> <span>S</span><span>)</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Recv</span><span>&lt;</span><span>T</span><span>,</span> <span>S</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>(</span><span>T</span><span>,</span> <span>S</span><span>)</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Offer</span><span>&lt;</span><span>Left</span><span>,</span> <span>Right</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>(</span><span>Left</span><span>,</span> <span>Right</span><span>)</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Choose</span><span>&lt;</span><span>Left</span><span>,</span> <span>Right</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>(</span><span>Left</span><span>,</span> <span>Right</span><span>)</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Label</span><span>&lt;</span><span>S</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>S</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Goto</span><span>&lt;</span><span>N</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>N</span><span>&gt;</span><span>);</span>
<span>struct</span> <span>Z</span><span>;</span>
<span>struct</span> <span>S</span><span>&lt;</span><span>N</span><span>&gt;</span><span>(</span><span>PhantomData</span><span>&lt;</span><span>N</span><span>&gt;</span><span>);</span> <span>// Peano encoding for natural numbers</span>
<span>struct</span> <span>Close</span><span>;</span>

<span>struct</span> <span>Ping</span><span>;</span>
<span>type</span> <span>PingServer</span> <span>=</span>
  <span>Label</span><span>&lt;</span>
    <span>Offer</span><span>&lt;</span>
      <span>Send</span><span>&lt;</span><span>Ping</span><span>,</span>
        <span>Recv</span><span>&lt;</span><span>Ping</span><span>,</span>
        <span>Goto</span><span>&lt;</span><span>Z</span><span>&gt;&gt;&gt;</span><span>,</span>
      <span>Close</span><span>&gt;&gt;</span><span>;</span>
</code></pre></div></div>

<p>The runtime communication API uses the type-state concept as a channel whose type changes as the protocol advances. Initially, a <code>Chan</code> is created for the server and the client (the “dual” of the server). Here’s an example where the type annotations show the change.</p>

<div><div><pre><code><span>fn</span> <span>example_ping_server</span><span>()</span> <span>{</span>
  <span>let</span> <span>(</span><span>c</span><span>,</span> <span>_</span><span>):</span> <span>(</span><span>Chan</span><span>&lt;</span><span>(),</span> <span>PingServer</span><span>&gt;</span><span>,</span>
               <span>Chan</span><span>&lt;</span><span>(),</span> <span>Dual</span><span>&lt;</span><span>PingServer</span><span>&gt;</span><span>)</span> <span>=</span> <span>Chan</span><span>::</span><span>new</span><span>();</span>
  <span>let</span> <span>mut</span> <span>c</span><span>:</span> <span>Chan</span><span>&lt;</span><span>(</span><span>Offer</span><span>&lt;</span><span>_</span><span>,</span><span>_</span><span>&gt;</span><span>,</span> <span>()),</span> <span>Offer</span><span>&lt;</span><span>_</span><span>,</span><span>_</span><span>&gt;&gt;</span> <span>=</span> <span>c</span><span>.label</span><span>();</span>
  <span>loop</span> <span>{</span>
    <span>c</span> <span>=</span> <span>match</span> <span>c</span><span>.offer</span><span>()</span> <span>{</span>
      <span>Branch</span><span>::</span><span>Left</span><span>(</span><span>c</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>let</span> <span>c</span><span>:</span> <span>Chan</span><span>&lt;</span><span>_</span><span>,</span> <span>Recv</span><span>&lt;</span><span>_</span><span>,</span><span>_</span><span>&gt;&gt;</span> <span>=</span> <span>c</span><span>.send</span><span>(</span><span>Ping</span><span>);</span>
        <span>let</span> <span>(</span><span>c</span><span>,</span> <span>Ping</span><span>):</span> <span>(</span><span>Chan</span><span>&lt;</span><span>_</span><span>,</span> <span>Goto</span><span>&lt;</span><span>_</span><span>&gt;&gt;</span><span>,</span> <span>_</span><span>)</span> <span>=</span> <span>c</span><span>.recv</span><span>();</span>
        <span>c</span><span>.goto</span><span>()</span>
      <span>},</span>
      <span>Branch</span><span>::</span><span>Right</span><span>(</span><span>c</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>c</span><span>.close</span><span>();</span>
        <span>return</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div></div>

<p>Note that the <code>Chan</code> has two type arguments: an environment <code>Env</code> and a current action <code>Sigma</code>. The environment contains a list of session types generated by calls to <code>label</code>. When we <code>goto</code>, we look up the corresponding type in the <code>Env</code> list and …</p></div></div>
<br/><p><em>Article truncated for RSS feed. Read the full article at <a href="https://willcrichton.net/notes/type-level-programming/">https://willcrichton.net/notes/type-level-programming/</a></em></p>]]>
            </description>
            <link>https://willcrichton.net/notes/type-level-programming/</link>
            <guid isPermaLink="false">hacker-news-small-sites-24687685</guid>
            <pubDate>Mon, 05 Oct 2020 13:43:10 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[I built a lay-down desk]]>
            </title>
            <description>
<![CDATA[
Score 530 | Comments 354 (<a href="https://news.ycombinator.com/item?id=24687458">thread link</a>) | @polote
<br/>
October 5, 2020 | https://blog.luap.info/drafts/i-built-a-lay-down-desk.html?hnn | <a href="https://web.archive.org/web/*/https://blog.luap.info/drafts/i-built-a-lay-down-desk.html?hnn">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div>

		  <div role="main">
	<article>

		


		<p>After spending part of the last 12 months <a href="https://blog.luap.info/travelling-with-24-monitors.html">travelling in Europe</a> I'm now settling down around Paris and I need to adapt my multi-screens setup.</p>
<p>You probably have seen an ads for <a href="https://altwork.com/">the altwork desk</a> <em>a $7000 desk that let you work laying down</em>. Spending a big part of my day in front of a computer I want to have the most comfortable position as possible, but well $7000 + $1000 for the delivery seems so expensive. There is also <a href="http://www.ergoquest.com/">this company</a> but this is still about $4000 all included. Let's be creative and build it myself.</p>
<p>Here is the result</p>
<p><img alt="complete desk" src="https://blog.luap.info/drafts/static/desk/complete.jpg"> </p>
<p>The things I have to take into account are:</p>
<ul>
<li>
<p>I have three monitors</p>
</li>
<li>
<p>I have no diy tools</p>
</li>
<li>
<p>I want a laying down position</p>
</li>
<li>
<p>This should be easy to use</p>
</li>
<li>
<p>This should be light and not take too much space</p>
</li>
<li>
<p>I have only a bike to move the parts</p>
</li>
<li>
<p>I haven't found anyone who has done something similar and so don't really have examples</p>
</li>
</ul>
<p>So instead of doing the waterfall way I decided to go the agile way and to not do any plans, I didn't know what to expect, so let's do it step by step and see how it goes</p>
<h2>Take care of the chair</h2>
<p>There are several options:</p>
<ol>
<li>
<p>Built a chair from scratch including the 'mattress' part</p>
</li>
<li>
<p>Use a reclined chair</p>
</li>
<li>
<p>Adapt a chair</p>
</li>
</ol>
<p>The issue with the first option is that I will not be sure of the result, is it going to be comfortable ? How I'm going to wash the seat covers ? I have no idea of the things to take into account for building a comfortable chair.</p>
<p>Reclined chairs are great but they are very heavy (except the garden ones but not very comfortable) and expensive. So again let's be creative, I got inspired by <a href="https://www.ikeahackers.net/2017/04/poang-gravity-recliner.html">this</a> and <a href="https://www.ikeahackers.net/2020/04/remove-poang-arms.html">this</a> ikea hacks which use a IKEA POANG chair and transform it into a reclined chair.</p>
<p>Here is the result :</p>
<p><img alt="ikea poang adaptation" src="https://blog.luap.info/drafts/static/desk/chair.jpg"></p>
<p>The chair is 69 euro, I had to buy three cushions to extend it</p>
<p>The most complex part was to do 7km with the chair on a bike. I do not recommend doing the same, particularly because I have done it on a rainy day but well a bit of challenge in my life is always welcome!</p>
<p><img alt="ikea bike" src="https://blog.luap.info/drafts/static/desk/ikea_bike.jpg"></p>
<p>Great, the chair is comfortable, let's do something for the desk part.</p>
<h2>What structure for the desk</h2>
<p>The biggest issue you are going to have with the lay down position, is that the desk is going to be on your legs and you cant 'enter' or 'leave' the desk if you can't move the desk. So you need the 'desk' part to be dynamic from the 'chair' part.</p>
<p>I had two ideas for that, either the Altwork way, the structure goes above your head and can incline, or the the base is on the side and the desk can move somewhere (writing that, having the desk in front of me, I wonder if having the base where the foot are is not an even better solution ? Damn, too late). Having the base on the side seems better because it would be smaller and lighter and also you can balance the weight much better. But the structure also needs to be more rigid and I need to find a way to incline the desk, anyway I haven't found a way to do it :(, after a night of thinking I went the altwork way.</p>
<p>There are two parts to design:</p>
<ol>
<li>
<p>The base + the incline system</p>
</li>
<li>
<p>The desk + the screen supports</p>
</li>
</ol>
<h3>1. Base + incline system</h3>
<p>The base is pretty standard, you need something strong enough so that it can suppot the whole thing. At that point I still didn't know the weight of the complete platform so I didn't know how strong it should be. After a few failing choices, I ended up with a main pole of 7cm x 7cm.</p>
<p>Now the complex part, how to design the rotation part ? How heavy is going to be the rest of desk ? How much does the desk need to move so that I can 'enter' the desk ? So many questions I didnt have an answer for.</p>
<p>So let's try something and see how it goes, I bought an <a href="https://www.amazon.fr/gp/product/B00H8SZ87W">gaz actuator on Amazon</a> which can support 70kg with a range of 31cm, it is built for cars and pretty cheap, 19euro. Actually 70kg is a lot. So at least I have a some freedom on the weight of the structure.</p>
<p>I had two issues with the actuator:</p>
<ul>
<li>70kg IS A LOT, it is so much that when I was fixing it on the wood of the base, it was breaking the wood. The best would be to have an iron piece that I can fix to the wood but I didnt have the tools for that so I used stronger woods but this is still fragile. </li>
</ul>
<p><img alt="fixation verrin" src="https://blog.luap.info/drafts/static/desk/fixation_verrin.jpg"></p>
<ul>
<li>The desk follows a circular trajectory when you move it up and down. As a result the barycenter of the structure changes depending on the Y position of the 'desk part' and so there is more strength applied on the actuator when it is up than when it is down. So basically the desk will not stay by itself when in the up position.  I need to find a way to get the desk in the up position.</li>
</ul>
<p>I'm not really proud of the way I've done it, but it somewhat works. I've built a piece of wood that inserts itself in the area between the two poles where the actuator is. There is a counterweight which drags the piece into the zone when in up position, and when I want to release it, I just need to pull on the rope. (I think I will replace the actuator with a real electric actuator when the current system breaks so that I can control the movement, it is about 120euro)</p>
<p><img alt="system block" src="https://blog.luap.info/drafts/static/desk/blocking_system.jpg"></p>
<h3>2. Desk + screens support</h3>
<p>I bought a chipboard plate of 80cm x 120cm, and cut some space for my body</p>
<p><img alt="plaque bois" src="https://blog.luap.info/drafts/static/desk/agglo.jpg"> </p>
<p>This is pretty solid, so I can directly screw this plate to the pole and we have a desk surface</p>
<p><img alt="plaque bureau" src="https://blog.luap.info/drafts/static/desk/bureau_with_plaque.jpg"></p>
<p>For holding the monitors I did something pretty basic, I created a box for each screen. Then comes the position of the screen, how to know the position of each screen ? I didnt know how to know it beforehand, so I just created dynamic arms and adjusted them while in front of the screens</p>
<p><img alt="support monitor" src="https://blog.luap.info/drafts/static/desk/support_monitor.jpg"></p>
<h2>Next steps</h2>
<p>This is only a few days old so I can't really make a feedback but there are already a few things that I need to fix</p>
<ul>
<li>
<p>I can't use a mouse anymore, as the mouse would fall down, I'm probably going to replace it by a trackball</p>
</li>
<li>
<p>I need to invest in an ergonomic keyboard to get really comfortable, probably going to buy the kenesis advantage 2, but this is expensive !</p>
</li>
</ul>
<p>Here is a video of the complete desk:</p>
<video controls="">
  <source src="https://blog.luap.info/drafts/static/desk/video.mp4" type="video/mp4">
</video>

<h2>Conclusion</h2>
<p>When you want to build this kind of structure, I'm not sure you can plan everything beforehand, there are always things that will happen that you didn't expect, like when you code: if you want to modify the actuator when the 60kg setup is mounted how do you do ? (I have done it 6 times) When your base can't support the weight because it lacks one screw and you need to unmount everything what do you do ? ...</p>
<p>I'm really annoyed by the actuator part, I hope I will find something more reliable</p>
<p>Overall it cost me :</p>
<ul>
<li>
<p>45 euro for tools</p>
</li>
<li>
<p>130 euro for wood pieces, screws, joins, ...</p>
</li>
<li>
<p>110 euro for the IKEA chair + cushions</p>
</li>
</ul>
<p>and I spent 26 hours working, excluding the transport and the time shopping for pieces</p>
<p>Don't forget when you do woodworking to clean afterwards  :)</p>
<p><img alt="dirty" src="https://blog.luap.info/drafts/static/desk/dirty_floor.jpg"></p>
<p>If you have done something similar and know a few advice, please send me an email</p>
<p>PS: If you wonder whether you can do that or not, everyone can do it, basic woodworking is not complex, you need to know how to cut wood, how to join wood, how to screw and a little bit of imagination, you dont even need a car to transport parts, I transported everything: pole of 2m40, big plate ... on a bike</p>	

	</article>


		  </div>	

		  

	  </div></div>]]>
            </description>
            <link>https://blog.luap.info/drafts/i-built-a-lay-down-desk.html?hnn</link>
            <guid isPermaLink="false">hacker-news-small-sites-24687458</guid>
            <pubDate>Mon, 05 Oct 2020 13:14:31 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Concatenative Programming; the Free Monoid of Programming Languages (2019)]]>
            </title>
            <description>
<![CDATA[
Score 59 | Comments 8 (<a href="https://news.ycombinator.com/item?id=24687026">thread link</a>) | @gbrown_
<br/>
October 5, 2020 | https://doisinkidney.com/posts/2019-05-11-concatenative-free.html | <a href="https://web.archive.org/web/*/https://doisinkidney.com/posts/2019-05-11-concatenative-free.html">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div id="content">
            

            <p>
    Posted on May 11, 2019
</p>



<p>This post demonstrates a simple encoding of a (typed) concatenative language in Haskell.</p>
<p>Point-free style is one of the distinctive markers of functional programming languages. Want to sum a list? That’s as easy as:</p>

<p>Now I want to sum every number after adding one to it.</p>
<div id="cb2"><pre><code><span id="cb2-1">sumSuccs <span>=</span> <span>foldr</span> (<span>+</span>) <span>0</span> <span>.</span> <span>map</span> ((<span>+</span>) <span>1</span>)</span></code></pre></div>
<p>One more step to make this function truly abstract™ and general™: we’ll allow the user to supply their own number to add</p>
<div id="cb3"><pre><code><span id="cb3-1">sumAdded <span>=</span> <span>foldr</span> (<span>+</span>) <span>0</span> <span>.</span> <span>map</span> <span>.</span> (<span>+</span>)</span></code></pre></div>
<p>And here the trouble begins. The above expression won’t actually type check. In fact, it’ll give a pretty terrible error message:</p>
<pre><code>• Non type-variable argument in the constraint: Num [a]
  (Use FlexibleContexts to permit this)
• When checking the inferred type
    sumThoseThat :: forall a.
                    (Num [a], Foldable ((-&gt;) [a])) =&gt;
                    a -&gt; [a]</code></pre>
<p>I remember as a beginner being confused by similar messages. What’s <code>FlexibleContexts</code>? I had thought that the “point-free style” just meant removing the last variable from an expression if it’s also the last argument:</p>
<div id="cb5"><pre><code><span id="cb5-1"><span>sum</span> xs <span>=</span> <span>foldr</span> (<span>+</span>) <span>0</span> xs</span>
<span id="cb5-2"><span>sum</span> <span>=</span> <span>foldr</span> (<span>+</span>) <span>0</span></span></code></pre></div>
<p>Why doesn’t it work here?</p>
<p>Well, it doesn’t work because the types don’t line up, but I’m going to try and explain a slightly different perspective on the problem, which is <em>associativity</em>.</p>
<p>To make it a little clearer, let’s see what happens when we point-fill the expression:</p>
<div id="cb6"><pre><code><span id="cb6-1">sumAdded n xs <span>=</span> (<span>foldr</span>(<span>+</span>) <span>0</span> <span>.</span> (<span>map</span> <span>.</span> (<span>+</span>))) n xs</span>
<span id="cb6-2">             <span>=&gt;</span> <span>foldr</span>(<span>+</span>) <span>0</span> ((<span>map</span> <span>.</span> (<span>+</span>)) n) xs</span>
<span id="cb6-3">             <span>=&gt;</span> <span>foldr</span>(<span>+</span>) <span>0</span> (<span>map</span> ((<span>+</span>) n)) xs</span></code></pre></div>
<p>Indeed, the problem is the placement of the parentheses. What we want at the end is:</p>
<div id="cb7"><pre><code><span id="cb7-1">             <span>=&gt;</span> <span>foldr</span>(<span>+</span>) <span>0</span> (<span>map</span> ((<span>+</span>) n) xs)</span></code></pre></div>
<p>But, no matter. We have to jiggle the arguments around, or we could use something terrible like this:</p>
<div id="cb8"><pre><code><span id="cb8-1"><span>infixr</span> <span>9</span> <span>.:</span></span>
<span id="cb8-2">(<span>.:</span>) <span>=</span> (<span>.</span>)<span>.</span>(<span>.</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">sumAdded <span>=</span> <span>foldr</span> (<span>+</span>) <span>0</span> <span>.:</span> <span>map</span> <span>.</span> (<span>+</span>)</span></code></pre></div>
<p>Is there something, though, that could do this automatically?</p>

<p>We run into a similar problem in Agda. We’re forever having to prove statements like:</p>
<div id="cb9"><pre><code><span id="cb9-1"><span>(</span>x + y<span>)</span> + z ≡ x + <span>(</span>y + z<span>)</span></span>
<span id="cb9-2">x ≡ x + <span>0</span></span></code></pre></div>
<p>There are a couple of ways to get around the issue, and for monoids there’s a rich theory of techniques. I’ll just show one for now, which relies on the <em>endomorphism</em> monoid. This monoid is created by partially applying the monoid’s binary operator:</p>
<div id="cb10"><pre><code><span id="cb10-1">Endo <span>:</span> <span>Set</span></span>
<span id="cb10-2">Endo <span>=</span> ℕ <span>→</span> ℕ</span>
<span id="cb10-3"></span>
<span id="cb10-4">⟦<span>_</span>⇑⟧ <span>:</span> ℕ <span>→</span> Endo</span>
<span id="cb10-5">⟦ n ⇑⟧ m <span>=</span> n + m</span></code></pre></div>
<p>And you can get back to the underlying monoid by applying it to the neutral element:</p>
<div id="cb11"><pre><code><span id="cb11-1">⟦<span>_</span>⇓⟧ <span>:</span> Endo <span>→</span> ℕ</span>
<span id="cb11-2">⟦ n ⇓⟧ <span>=</span> n <span>0</span></span></code></pre></div>
<p>Here’s the important parts: first, we can lift the underlying operation into the endomorphism:</p>
<div id="cb12"><pre><code><span id="cb12-1"><span>_</span>⊕<span>_</span> <span>:</span> Endo <span>→</span> Endo <span>→</span> Endo</span>
<span id="cb12-2">xs ⊕ ys <span>=</span> <span>λ</span> x <span>→</span> xs <span>(</span>ys x<span>)</span></span>
<span id="cb12-3"></span>
<span id="cb12-4">⊕-homo <span>:</span> <span>∀</span> n m <span>→</span> ⟦ ⟦ n ⇑⟧ ⊕ ⟦ m ⇑⟧ ⇓⟧ ≡ n + m</span>
<span id="cb12-5">⊕-homo n m <span>=</span> cong <span>(</span>n +<span>_)</span> <span>(</span>+-identityʳ m<span>)</span></span></code></pre></div>
<p>And second, it’s <em>definitionally</em> associative.</p>
<div id="cb13"><pre><code><span id="cb13-1">⊕-assoc <span>:</span> <span>∀</span> x y z <span>→</span> <span>(</span>x ⊕ y<span>)</span> ⊕ z ≡ x ⊕ <span>(</span>y ⊕ z<span>)</span></span>
<span id="cb13-2">⊕-assoc <span>_</span> <span>_</span> <span>_</span> <span>=</span> refl</span></code></pre></div>
<p>These are all clues as to how to solve the composition problem in the Haskell code above. We need definitional associativity, somehow. Maybe we can get it from the endomorphism monoid?</p>

<p>You’re probably familiar with Haskell’s state monad:</p>
<div id="cb14"><pre><code><span id="cb14-1"><span>newtype</span> <span>State</span> s a <span>=</span> <span>State</span> {<span> runState ::</span> s <span>-&gt;</span> (a, s) }</span></code></pre></div>
<p>It can help a lot when you’re threading around fiddly accumulators and so on.</p>
<div id="cb15"><pre><code><span id="cb15-1"><span>nub ::</span> <span>Ord</span> a <span>=&gt;</span> [a] <span>-&gt;</span> [a]</span>
<span id="cb15-2">nub <span>=</span> go Set.empty</span>
<span id="cb15-3">  <span>where</span></span>
<span id="cb15-4">    go seen [] <span>=</span> []</span>
<span id="cb15-5">    go seen (x<span>:</span>xs)</span>
<span id="cb15-6">      <span>|</span> x <span>`Set.member`</span> seen <span>=</span> go seen xs</span>
<span id="cb15-7">      <span>|</span> <span>otherwise</span> <span>=</span> x <span>:</span> go (Set.insert x seen) xs</span></code></pre></div>
<div id="cb16"><pre><code><span id="cb16-1"><span>nub ::</span> <span>Ord</span> a <span>=&gt;</span> [a] <span>-&gt;</span> [a]</span>
<span id="cb16-2">nub <span>=</span> <span>flip</span> evalState Set.empty <span>.</span> go</span>
<span id="cb16-3">  <span>where</span></span>
<span id="cb16-4">    go [] <span>=</span> <span>pure</span> []</span>
<span id="cb16-5">    go (x<span>:</span>xs) <span>=</span> <span>do</span></span>
<span id="cb16-6">        seen <span>&lt;-</span> gets (Set.member x)</span>
<span id="cb16-7">        <span>if</span> seen</span>
<span id="cb16-8">          <span>then</span> go xs</span>
<span id="cb16-9">          <span>else</span> <span>do</span></span>
<span id="cb16-10">              modify (Set.insert x)</span>
<span id="cb16-11">              (x<span>:</span>) <span>&lt;$&gt;</span> go xs</span></code></pre></div>
<p>Of course, these days state is a transformer:</p>
<div id="cb17"><pre><code><span id="cb17-1"><span>newtype</span> <span>StateT</span> s m a <span>=</span> <span>StateT</span> {<span> runStateT ::</span> s <span>-&gt;</span> m (a, s) }</span></code></pre></div>
<p>This lets us stack multiple effects on top of each other: error handling, IO, randomness, even another state monad. In fact, if you <em>do</em> stack another state monad on top, you might be surprised by the efficiency of the code it generates:</p>
<div id="cb18"><pre><code><span id="cb18-1"><span>type</span> <span>DoubleState</span> s1 s2 a <span>=</span> <span>StateT</span> s1 (<span>State</span> s2) a</span>
<span id="cb18-2">                        <span>=&gt;</span> s1 <span>-&gt;</span> <span>State</span> s2 (a, s1)</span>
<span id="cb18-3">                        <span>=&gt;</span> s1 <span>-&gt;</span> s2 <span>-&gt;</span> ((a, s1), s2)</span></code></pre></div>
<p>It’s nothing earth shattering, but it inlines and optimises well. That output is effectively a left-nested list, also.</p>

<p>If we can do one, and we can do two, why not more? Can we generalise the state pattern to an arbitrary number of variables? First we’ll need a generic tuple:</p>
<div id="cb19"><pre><code><span id="cb19-1"><span>infixr</span> <span>5</span> <span>:-</span></span>
<span id="cb19-2"><span>data</span> <span>Stack</span> (<span>xs ::</span> [<span>Type</span>])<span> ::</span> <span>Type</span> <span>where</span></span>
<span id="cb19-3">    <span>Nil</span><span>  ::</span> <span>Stack</span> '[]</span>
<span id="cb19-4"><span>    (:-) ::</span> x <span>-&gt;</span> <span>Stack</span> xs <span>-&gt;</span> <span>Stack</span> (x <span>:</span> xs)</span></code></pre></div>
<p>Then, the state type.</p>
<div id="cb20"><pre><code><span id="cb20-1"><span>newtype</span> <span>State</span> xs a <span>=</span> <span>State</span> {<span> runState ::</span> <span>Stack</span> xs <span>-&gt;</span> (a, <span>Stack</span> xs) }</span></code></pre></div>
<p>We can actually clean the definition up a little: instead of a tuple at the other end, why not push it onto the stack.</p>
<div id="cb21"><pre><code><span id="cb21-1"><span>newtype</span> <span>State</span> xs a <span>=</span> <span>State</span> {<span> runState ::</span> <span>Stack</span> xs <span>-&gt;</span> <span>Stack</span> (a <span>:</span> xs) }</span></code></pre></div>
<p>In fact, let’s make this as polymorphic as possible. We should be able to change the state is we so desire.</p>
<div id="cb22"><pre><code><span id="cb22-1"><span>infixr</span> <span>0</span> <span>:-&gt;</span></span>
<span id="cb22-2"><span>type</span> (<span>:-&gt;</span>) xs ys <span>=</span> <span>Stack</span> xs <span>-&gt;</span> <span>Stack</span> ys</span></code></pre></div>
<p>And suddenly, our endomorphism type from above shows up again.</p>
<p>We can, of course, get back our original types.</p>
<div id="cb23"><pre><code><span id="cb23-1"><span>newtype</span> <span>State</span> xs a <span>=</span> <span>State</span> {<span> runState ::</span> xs <span>:-&gt;</span> a <span>:</span> xs }</span></code></pre></div>
<p>And it comes with all of the instances you might expect:</p>
<div id="cb24"><pre><code><span id="cb24-1"><span>instance</span> <span>Functor</span> (<span>State</span> xs) <span>where</span></span>
<span id="cb24-2">    <span>fmap</span> f xs <span>=</span> <span>State</span> (\s <span>-&gt;</span> <span>case</span> runState xs s <span>of</span></span>
<span id="cb24-3">        (x <span>:-</span> ys) <span>-&gt;</span> f x <span>:-</span> ys)</span>
<span id="cb24-4">        </span>
<span id="cb24-5"><span>instance</span> <span>Applicative</span> (<span>State</span> xs) <span>where</span></span>
<span id="cb24-6">    <span>pure</span> x <span>=</span> <span>State</span> (x <span>:-</span>)</span>
<span id="cb24-7">    fs <span>&lt;*&gt;</span> xs <span>=</span> <span>State</span> (\s <span>-&gt;</span> <span>case</span> runState fs s <span>of</span></span>
<span id="cb24-8">        (f <span>:-</span> s') <span>-&gt;</span> <span>case</span> runState xs s' <span>of</span></span>
<span id="cb24-9">            (x <span>:-</span> s'') <span>-&gt;</span> f x <span>:-</span> s'')</span>
<span id="cb24-10">            </span>
<span id="cb24-11"><span>instance</span> <span>Monad</span> (<span>State</span> xs) <span>where</span></span>
<span id="cb24-12">    xs <span>&gt;&gt;=</span> f <span>=</span> <span>State</span> (\s <span>-&gt;</span> <span>case</span> runState xs s <span>of</span></span>
<span id="cb24-13">        y <span>:-</span> ys <span>-&gt;</span> runState (f y) ys)</span></code></pre></div>

<p>But what’s the point? So far we’ve basically just encoded an unnecessarily complicated state transformer. Think back to the stacking of states. Written in the <a href="https://hackage.haskell.org/package/mtl">mtl</a> style, the main advantage of stacking monads like that is you can write code like the following:</p>
<div id="cb25"><pre><code><span id="cb25-1"><span>pop ::</span> (<span>MonadState</span> [a] m, <span>MonadError</span> <span>String</span> m) <span>=&gt;</span> m a</span>
<span id="cb25-2">pop <span>=</span> get <span>&gt;&gt;=</span> \<span>case</span></span>
<span id="cb25-3">    [] <span>-&gt;</span> throwError <span>"pop: empty list"</span></span>
<span id="cb25-4">    x<span>:</span>xs <span>-&gt;</span> <span>do</span></span>
<span id="cb25-5">        put xs </span>
<span id="cb25-6">        <span>pure</span> x</span></code></pre></div>
<p>In other words, we don’t care about the rest of <code>m</code>, we just care that it has, somewhere, state for an <code>[a]</code>.</p>
<p>This logic should apply to our stack transformer, as well. If it only cares about the top two variables, it shouldn’t care what the rest of the list is. In types:</p>
<div id="cb26"><pre><code><span id="cb26-1"><span>infixr</span> <span>0</span> <span>:-&gt;</span></span>
<span id="cb26-2"><span>type</span> (<span>:-&gt;</span>) xs ys <span>=</span> <span>forall</span> zs<span>.</span> <span>Stack</span> (xs <span>++</span> zs) <span>-&gt;</span> <span>Stack</span> (ys <span>++</span> zs)</span></code></pre></div>
<p>And straight away we can write some of the standard combinators:</p>
<div id="cb27"><pre><code><span id="cb27-1"><span>dup ::</span> '[a] <span>:-&gt;</span> '[a,a]</span>
<span id="cb27-2">dup (x <span>:-</span> xs) <span>=</span> (x <span>:-</span> x <span>:-</span> xs)</span>
<span id="cb27-3"></span>
<span id="cb27-4"><span>swap ::</span> '[x,y] <span>:-&gt;</span> '[y,x]</span>
<span id="cb27-5">swap (x <span>:-</span> y <span>:-</span> xs) <span>=</span> y <span>:-</span> x <span>:-</span> xs</span>
<span id="cb27-6"></span>
<span id="cb27-7"><span>drop</span><span> ::</span> '[x,y] <span>:-&gt;</span> '[y]</span>
<span id="cb27-8"><span>drop</span> (_ <span>:-</span> xs) <span>=</span> xs</span>
<span id="cb27-9"></span>
<span id="cb27-10"><span>infixl</span> <span>9</span> <span>!</span></span>
<span id="cb27-11">(f <span>!</span> g) x <span>=</span> g (f x)</span></code></pre></div>
<p>You’ll immediately run into trouble if you try to work with some of the more involved combinators, though. Quote should have the following type, for instance:</p>
<div id="cb28"><pre><code><span id="cb28-1"><span>quote ::</span> (xs <span>:-&gt;</span> ys) <span>-&gt;</span> '[] <span>:-&gt;</span> '[ xs <span>:-&gt;</span> ys ]</span></code></pre></div>
<p>But GHC complains again:</p>
<pre><code>• Illegal polymorphic type: xs :-&gt; ys
  GHC doesn't yet support impredicative polymorphism
• In the type signature:
    quote :: (xs :-&gt; ys) -&gt; '[] :-&gt; '[xs :-&gt; ys]</code></pre>
<p>I won’t go into the detail of this particular error: if you’ve been around the block with Haskell you know that it means “wrap it in a newtype”. If we do <em>that</em>, though, we get yet more errors:</p>
<div id="cb30"><pre><code><span id="cb30-1"><span>newtype</span> (<span>:~&gt;</span>) xs ys <span>=</span> <span>Q</span> {<span> d ::</span> xs <span>:-&gt;</span> ys }</span></code></pre></div>
<pre><code>• Couldn't match type ‘ys ++ zs0’ with ‘ys ++ zs’
  Expected type: Stack (xs ++ zs) -&gt; Stack (ys ++ zs)
    Actual type: Stack (xs ++ zs0) -&gt; Stack (ys ++ zs0)
  NB: ‘++’ is a type function, and may not be injective</code></pre>
<p>This injectivity error comes up often. It means that GHC needs to prove that the input to two functions is equal, but it only knows that their outputs are. This is a doubly serious problem for us, as we can’t do type family injectivity on two type variables (in current Haskell). To solve the problem, we need to rely on a weird mishmash of type families and functional dependencies:</p>
<div id="cb32"><pre><code><span id="cb32-1"><span>type</span> <span>family</span> (<span>++</span>) xs ys <span>where</span></span>
<span id="cb32-2">    '[] <span>++</span> ys <span>=</span> ys</span>
<span id="cb32-3">    (x <span>:</span> xs) <span>++</span> ys <span>=</span> x <span>:</span> (xs <span>++</span> ys)</span>
<span id="cb32-4">    </span>
<span id="cb32-5"><span>class</span> (xs <span>++</span> ys <span>~</span> zs) <span>=&gt;</span> <span>Conc</span> xs ys zs <span>|</span> xs zs <span>-&gt;</span> ys <span>where</span></span>
<span id="cb32-6"><span>    conc ::</span> <span>Stack</span> xs <span>-&gt;</span> <span>Stack</span> ys <span>-&gt;</span> <span>Stack</span> zs</span>
<span id="cb32-7">    </span>
<span id="cb32-8"><span>instance</span> <span>Conc</span> '[] ys ys <span>where</span></span>
<span id="cb32-9">    conc _ ys <span>=</span> ys</span>
<span id="cb32-10">    </span>
<span id="cb32-11"><span>instance</span> <span>Conc</span> xs ys zs <span>=&gt;</span> <span>Conc</span> (x <span>:</span> xs) ys (x <span>:</span> zs) <span>where</span></span>
<span id="cb32-12">    conc (x <span>:-</span> xs) ys <span>=</span> x <span>:-</span> conc xs ys</span>
<span id="cb32-13"></span>
<span id="cb32-14"><span>infixr</span> <span>0</span> <span>:-&gt;</span></span>
<span id="cb32-15"><span>type</span> (<span>:-&gt;</span>) xs ys <span>=</span> <span>forall</span> zs yszs<span>.</span> <span>Conc</span> ys zs yszs <span>=&gt;</span> <span>Stack</span> (xs <span>++</span> zs) <span>-&gt;</span> <span>Stack</span> yszs</span></code></pre></div>
<p>And it does indeed work:</p>
<div id="cb33"><pre><code><span id="cb33-1"><span>pure</span><span> ::</span> a <span>-&gt;</span> '[] <span>:-&gt;</span> '[a]</span>
<span id="cb33-2"><span>pure</span> <span>=</span> (<span>:-</span>)</span>
<span id="cb33-3"></span>
<span id="cb33-4"><span>newtype</span> (<span>:~&gt;</span>) xs ys <span>=</span> <span>Q</span> {<span> d ::</span> xs <span>:-&gt;</span> ys }</span>
<span id="cb33-5"></span>
<span id="cb33-6"><span>quote ::</span> (xs <span>:-&gt;</span> ys) <span>-&gt;</span> '[] <span>:-&gt;</span> '[ xs <span>:~&gt;</span> ys ]</span>
<span id="cb33-7">quote x <span>=</span> <span>pure</span> (<span>Q</span> x)</span>
<span id="cb33-8"></span>
<span id="cb33-9"><span>dot ::</span> <span>forall</span> xs ys<span>.</span> ((xs <span>:~&gt;</span> ys) <span>:</span> xs) <span>:-&gt;</span> ys</span>
<span id="cb33-10">dot (x <span>:-</span> xs) <span>=</span> d x xs</span>
<span id="cb33-11"></span>
<span id="cb33-12"><span>true ::</span> (xs <span>:~&gt;</span> ys) <span>:</span> (xs <span>:~&gt;</span> ys) <span>:</span> xs <span>:-&gt;</span> ys</span>
<span id="cb33-13">true <span>=</span> swap <span>!</span> <span>drop</span> <span>!</span> dot</span>
<span id="cb33-14"></span>
<span id="cb33-15"><span>false ::</span> (xs <span>:~&gt;</span> ys) <span>:</span> (xs <span>:~&gt;</span> ys) <span>:</span> xs <span>:-&gt;</span> ys</span>
<span id="cb33-16">false <span>=</span> <span>drop</span> <span>!</span> dot</span>
<span id="cb33-17"></span>
<span id="cb33-18"><span>test ::</span> '[] <span>:-&gt;</span> '[ '[a] <span>:~&gt;</span> '[a,a] ]</span>
<span id="cb33-19">test <span>=</span> quote dup</span></code></pre></div>
<p>Interestingly, these combinators represent the monadic operations on state (<code>dot</code> = <code>join</code>, <code>pure</code> = <code>pure</code>, etc.)</p>
<p>And can we get the nicer composition of the function from the intro? Kind of:</p>
<div id="cb34"><pre><code><span id="cb34-1">sumAdded <span>=</span> quote add <span>!</span> <span>curry</span> <span>!</span> dot <span>!</span> <span>map</span> <span>!</span> <span>sum</span></span></code></pre></div>
<p>Here are some references for concatenative languages: <span data-cites="okasaki_techniques_2002">Okasaki (<a href="#ref-okasaki_techniques_2002" role="doc-biblioref">2002</a>)</span>, <span data-cites="purdy_big_2012">Purdy (<a href="#ref-purdy_big_2012" role="doc-biblioref">2012</a>)</span>, <span data-cites="kerby_theory_2007">Kerby (<a href="#ref-kerby_theory_2007" role="doc-biblioref">2007</a>)</span>, <span data-cites="okasaki_theoretical_2003">Okasaki (<a href="#ref-okasaki_theoretical_2003" role="doc-biblioref">2003</a>)</span>.</p>


        </div></div>]]>
            </description>
            <link>https://doisinkidney.com/posts/2019-05-11-concatenative-free.html</link>
            <guid isPermaLink="false">hacker-news-small-sites-24687026</guid>
            <pubDate>Mon, 05 Oct 2020 12:19:25 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Principles of Data Oriented Programming]]>
            </title>
            <description>
<![CDATA[
Score 350 | Comments 127 (<a href="https://news.ycombinator.com/item?id=24686863">thread link</a>) | @viebel
<br/>
October 5, 2020 | https://blog.klipse.tech/databook/2020/09/29/do-principles.html?essence | <a href="https://web.archive.org/web/*/https://blog.klipse.tech/databook/2020/09/29/do-principles.html?essence">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting">

  
  <div itemprop="articleBody">
    <div>
  <p>
    This article is an excerpt from my upcoming book about Data Oriented Programming. The book will be published by Manning, once it is completed (hopefully in 2021).
  </p>

  <p>
    More excerpts are available on my <a href="https://blog.klipse.tech/data-oriented-programming-book.html">blog</a>.
  </p>

  <p>
    Enter your email address below to get notified when the book is published.
  </p>

  
  <br>
</div>
<p>This chapter is an attempt to illustrate what are the core principles of Data Oriented Programming as I understand them.
It is highly influenced by my programming experience in Clojure, but I believe that those principles are language agnostic.</p>
<p>One could adhere to them in an Object Oriented (OO) language like Java or C# and one could break them
in a Functional Programming (FP) language like Ocaml, Haskell, JavaScript (or even in Clojure).</p>
<p>In fact, in this chapter, I am going to illustrate how those principles could be applied or broken
in JavaScript, a programming language that supports both FP and OOP.</p>
<p>The principles of Data Oriented (DO) Programming are:</p>

<p>Each principle is explored in a separate article.</p>

<p>Enjoy!</p>
<div>
  <p>
    This article is an excerpt from my upcoming book about Data Oriented Programming. The book will be published by Manning, once it is completed (hopefully in 2021).
  </p>

  <p>
    More excerpts are available on my <a href="https://blog.klipse.tech/data-oriented-programming-book.html">blog</a>.
  </p>

  <p>
    Enter your email address below to get notified when the book is published.
  </p>

  
  <br>
</div>
  </div>

</article><p>
  If you enjoy this kind of interactive articles would you consider a (small) donation💸  on <a href="https://www.patreon.com/bePatron?u=18227864">Patreon</a> or at least giving a star⭐ for the Klispe repo on <a href="https://github.com/viebel/klipse/stargazers"> Github</a>?
</p></div>]]>
            </description>
            <link>https://blog.klipse.tech/databook/2020/09/29/do-principles.html?essence</link>
            <guid isPermaLink="false">hacker-news-small-sites-24686863</guid>
            <pubDate>Mon, 05 Oct 2020 11:59:42 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Fortunately, I don't squash my commits]]>
            </title>
            <description>
<![CDATA[
Score 274 | Comments 319 (<a href="https://news.ycombinator.com/item?id=24686527">thread link</a>) | @lelf
<br/>
October 5, 2020 | https://blog.ploeh.dk/2020/10/05/fortunately-i-dont-squash-my-commits/ | <a href="https://web.archive.org/web/*/https://blog.ploeh.dk/2020/10/05/fortunately-i-dont-squash-my-commits/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div id="post">
	<p>
		<em>The story of a bug, and how I addressed it.</em>
	</p>
	<p>
		Okay, I admit it: I could have given this article all sorts of alternative titles, each of which would have made as much sense as the one I chose. I didn't want to go with some of the other titles I had in mind, because they would give it all away up front. I didn't want to spoil the surprise.
	</p>
	<p>
		I recently ran into this bug, it took me hours to troubleshoot it, and I was appalled when I realised what the problem was.
	</p>
	<p>
		This is the story of that bug.
	</p>
	<p>
		There are several insights from this story, and I admit that I picked the most click-baity one for the title.
	</p>
	<h3 id="94bc204499df483897121bb0343f73f7">
		Yak shaving <a href="#94bc204499df483897121bb0343f73f7" title="permalink">#</a>
	</h3>
	<p>
		I was working on the umpteenth variation of an online restaurant reservations system, and one of the features I'd added was a schedule only visible to the <a href="https://en.wikipedia.org/wiki/Ma%C3%AEtre_d%27h%C3%B4tel">maître d'</a>. The schedule includes a list of all reservations for a day, including guests' email addresses and so on. For that reason, I'd protected that resource by requiring a valid <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Token</a> (JWT) with an appropriate role.
	</p>
	<p>
		I'd deployed a new version of the API and went for an ad-hoc test. To my surprise, that particular resource didn't work. When I tried to request it, I got a <code>403 Forbidden</code> response.
	</p>
	<p>
		"That's odd," I though, "it worked the last time I tried this."
	</p>
	<p>
		The system is set up with continuous deployment. I push <em>master</em> to a remote repository, and a build pipeline takes over from there. It only deploys the new version if all tests pass, so my first reaction was that I might have made a mistake with the JWT.
	</p>
	<p>
		I wasted significant time decoding the JWT and comparing its contents to what it was supposed to be. I couldn't find any problems.
	</p>
	<p>
		I also meticulously compared the encryption key I'd used to sign the JWT with the key on the server. They were identical.
	</p>
	<p>
		Incredulous, and running out of ideas, I tried running all tests on my development machine. Indeed, all 170 tests passed.
	</p>
	<p>
		Finally, I gave up and ran the API on my development machine. It takes all of a 30 seconds to configure the code to run in that environment, so you're excused if you wonder why I didn't already do that. What can I say? I've almost two decades of experience with automated test suites. Usually, if all tests pass, the problem is environmental: a network topology issue, a bad or missing connection string, a misconfigured encryption key, an invalid JWT, things like that.
	</p>
	<p>
		To my surprise, the problem also manifested on my machine.
	</p>
	<h3 id="b726532ae06844eb8aeaa2c27ca0d913">
		Not my code <a href="#b726532ae06844eb8aeaa2c27ca0d913" title="permalink">#</a>
	</h3>
	<p>
		Okay, even with hundreds of tests, perhaps some edge case went unnoticed. The only problem with that hypothesis was that this was hardly an edge case. I was only making a <code>GET</code> request with a <code>Bearer</code> token. I wasn't going through some convoluted sequence of steps.
	</p>
	<pre>GET /restaurants/1/schedule/2020/9/30 HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5c[...]</pre>
	
	<p>
		I expected a successful response containing some JSON, but the result was <code>403 Forbidden</code>. That was the same behaviour I saw in the production environment.
	</p>
	<p>
		Now, to be clear, this is indeed a protected resource. If you present an invalid JWT, <code>403 Forbidden</code> is the expected response. That's why I wasted a few hours looking for problems with the the JWT.
	</p>
	<p>
		I finally, hesitatingly, concluded that the problem might be somewhere else. The JWT looked okay. So, hours into my troubleshooting I reluctantly set a breakpoint in my code and started the debugger. It isn't rational, but I tend to see it as a small personal defeat if I have to use the debugger. Even so, if used judiciously, it can be an effective way to identify problems.
	</p>
	<p>
		The debugger never hit my breakpoint.
	</p>
	<p>
		To be clear, the beginning of my Controller method looked like this:
	</p>
	<pre>[<span>Authorize</span>(Roles&nbsp;=&nbsp;<span>"MaitreD"</span>)]
[<span>HttpGet</span>(<span>"restaurants/{restaurantId}/schedule/{year}/{month}/{day}"</span>)]
<span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&lt;<span>ActionResult</span>&gt;&nbsp;Get(
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;restaurantId,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;year,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;month,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;day)
{
&nbsp;&nbsp;&nbsp;&nbsp;<span>if</span>&nbsp;(!AccessControlList.Authorize(restaurantId))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;<span>new</span>&nbsp;<span>ForbidResult</span>();</pre>
	
	<p>
		My breakpoint was on the first line (the <code>if</code> conditional), but the debugger didn't break into it. When I issued my <code>GET</code> request, I immediately got the <code>403 Forbidden</code> response. The breakpoint just sat there in the debugger, mocking me.
	</p>
	<p>
		When that happens, it's natural to conclude that the problem occurs somewhere in the framework; in this case, ASP.NET. To test that hypothesis, I commented out the <code>[Authorize]</code> attribute and reissued the <code>GET</code> request. My hypothesis was that I'd get a <code>200 OK</code> response, since the attribute is what tells ASP.NET to check authorisation.
	</p>
	<p>
		The hypothesis held. The response was <code>200 OK</code>.
	</p>
	<h3 id="fdff404f12644a898b6a3e695fb6533f">
		Test interdependency <a href="#fdff404f12644a898b6a3e695fb6533f" title="permalink">#</a>
	</h3>
	<p>
		I hate when that happens. It's up there with fixing other people's printers. The problem is in the framework, not in my code. I didn't have any authorisation callbacks registered, so I was fairly certain that the problem wasn't in my code.
	</p>
	<p>
		I rarely jump to the conclusion that there's a bug in the framework. In my experience, <a href="https://blog.codinghorror.com/the-first-rule-of-programming-its-always-your-fault">select is rarely broken</a>. My new hypothesis had to be that I'd somehow managed to misconfigure the framework.
	</p>
	<p>
		But where? There were automated tests that verified that a client could request that resource with a valid JWT. There were other automated tests that verified what happened if you presented an invalid JWT, or none at all. And all tests were passing.
	</p>
	<p>
		While I was fiddling with the tests, I eventually ran a parametrised test by itself, instead of the entire test suite:
	</p>
	<pre>[<span>Theory</span>]
[<span>InlineData</span>(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"Hipgnosta"</span>,&nbsp;2024,&nbsp;11,&nbsp;&nbsp;2)]
[<span>InlineData</span>(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>"Nono"</span>,&nbsp;2018,&nbsp;&nbsp;9,&nbsp;&nbsp;9)]
[<span>InlineData</span>(<span>"The&nbsp;Vatican&nbsp;Cellar"</span>,&nbsp;2021,&nbsp;10,&nbsp;10)]
<span>public</span>&nbsp;<span>async</span>&nbsp;<span>Task</span>&nbsp;GetRestaurantScheduleWhileAuthorized(
&nbsp;&nbsp;&nbsp;&nbsp;<span>string</span>&nbsp;name,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;year,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;month,
&nbsp;&nbsp;&nbsp;&nbsp;<span>int</span>&nbsp;day)</pre>
	
	<p>
		This parametrised test has three test cases. When I ran just that test method, two of the test cases passed, but one failed: the <em>Nono</em> case, for some reason I haven't yet figured out.
	</p>
	<p>
		I didn't understand why that test case ought to fail while the others succeeded, but I had an inkling. I commented out the <em>Nono</em> test case and ran the test method again.
	</p>
	<p>
		One passed and one failing test.
	</p>
	<p>
		Now <em>The Vatican Cellar</em> test case was failing. I commented that out and ran the test method again. The remaining test case failed.
	</p>
	<p>
		This reeks of some sort of test interdependency. Apparently, <em>something</em> happens during the first test run that makes succeeding tests pass, but it happens too late for the first one. But what?
	</p>
	<h3 id="c95c3e707f46467abbf8ff02a9594c4c">
		Bisect <a href="#c95c3e707f46467abbf8ff02a9594c4c" title="permalink">#</a>
	</h3>
	<p>
		Then something occurred to me that I should have thought of sooner. This feature used to work. Not only had the tests been passing, but I'd actually interacted with the deployed service, presenting a valid JWT and received a <code>200 OK</code> response.
	</p>
	<p>
		Once than dawned on me, I realised that it was just a manner of performing a binary search. Since, of course, I use version control, I had a version I knew worked, and a version that didn't work. The task, then, was to find the commit that introduced the defect.
	</p>
	<p>
		As I've already implied, the system in question is an example code base. While I have a cloud-based production environment, none but I use it. It had been four or five days since I'd actually interacted with the real service, and I'd been busy making changes, trusting exclusively in my test suite. I tend to make frequent, small commits instead of big, infrequent commits, so I had accumulated about a hundred and fifty commits since the 'last known good' deployment.
	</p>
	<p>
		Searching through hundreds of commits sounds overwhelming, but using binary search, it's actually not that bad. Pick the commit halfway between the 'last known good' commit and the most recent commit, and check it out. See if the defect is present there. If it is, you know that it was introduced somewhere between the commit you're looking at, and the 'last known good' commit. If it isn't present, it was introduced later. Regardless of the outcome, you know in which half to look. You now pick a new commit in the middle of that set and repeat the exercise. Even with, say, a hundred commits, the first bisection reduces the candidate set to 50, the next bisection to 25, then 13, then 7, 4, 2, and then you have it. If you do this systematically, you should find the exact commit in less than eight iterations.
	</p>
	<p>
		This is, as far as I understand it, the algorithm used by <em>Git bisect</em>. You don't have to use the <code>bisect</code> command - the algorithm is easy enough to do by hand - but let's see how it works.
	</p>
	<p>
		You start a <code>bisect</code> session with:
	</p>
	<pre><span>mark@Vindemiatrix</span> <span>MINGW64</span> <span>~/Documents/Redacted/Restaurant</span> <span>((93c6c35...))</span>
$ git bisect start

<span>mark@Vindemiatrix</span> <span>MINGW64</span> <span>~/Documents/Redacted/Restaurant</span> <span>((93c6c35...)|BISECTING)</span></pre>
	
	<p>
		This starts an interactive session, which you can tell from the Git integration in Git Bash (it says <code>BISECTING</code>). You now mark a commit as being bad:
	</p>
	<pre>$ git bisect bad

<span>mark@Vindemiatrix</span> <span>MINGW64</span> <span>~/Documents/Redacted/Restaurant</span> <span>((93c6c35...)|BISECTING)</span></pre>
	
	<p>
		If you don't provide a commit ID at that point, Git is going to assume that you meant that the current commit (in this case <code>93c6c35</code>) is bad. That's what I had in mind, so that's fine.
	</p>
	<p>
		You now tell it about a commit ID that you know is good:
	</p>
	<pre>$ git bisect good 7dfdab2
Bisecting: 75 revisions left to test after this (roughly 6 steps)
[1f78c9a90c2088423ab4fc145b7b2ec3859d6a9a] Use InMemoryRestaurantDatabase in a test

<span>mark@Vindemiatrix</span> <span>MINGW64</span> <span>~/Documents/Redacted/Restaurant</span> <span>((1f78c9a...)|BISECTING)</span></pre>
	
	<p>
		Notice that Git is already telling us how many iterations we should expect. You can also see that it checked out a new commit (<code>1f78c9a</code>) for you. That's the half-way commit.
	</p>
	<p>
		At this point, I manually ran the test method with the three test cases. All three passed, so I marked that commit as good:
	</p>
	<pre>$ git bisect good
Bisecting: 37 revisions left to test after this (roughly 5 steps)
[5abf65a72628efabbf05fccd1b79340bac4490bc] …</pre></div></div>
<br/><p><em>Article truncated for RSS feed. Read the full article at <a href="https://blog.ploeh.dk/2020/10/05/fortunately-i-dont-squash-my-commits/">https://blog.ploeh.dk/2020/10/05/fortunately-i-dont-squash-my-commits/</a></em></p>]]>
            </description>
            <link>https://blog.ploeh.dk/2020/10/05/fortunately-i-dont-squash-my-commits/</link>
            <guid isPermaLink="false">hacker-news-small-sites-24686527</guid>
            <pubDate>Mon, 05 Oct 2020 11:09:42 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Applying “make invalid states unrepresentable”]]>
            </title>
            <description>
<![CDATA[
Score 366 | Comments 180 (<a href="https://news.ycombinator.com/item?id=24685772">thread link</a>) | @fanf2
<br/>
October 5, 2020 | https://kevinmahoney.co.uk/articles/applying-misu/ | <a href="https://web.archive.org/web/*/https://kevinmahoney.co.uk/articles/applying-misu/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting" id="applying-make-invalid-states-unrepresentable">
  <div itemprop="articleBody">
    <p><time itemprop="datePublished">02 October 2020</time></p>

<p>Here are some real life cases of applying one of my
<a href="https://kevinmahoney.co.uk/articles/my-principles-for-building-software/">favourite principles</a>.</p>

<p>I’ll try to update this as I come across good examples.</p>

<h2 id="case-1-contiguous-time-periods">Case 1: Contiguous Time Periods</h2>

<p>A straightforward way to represent a period of time is by its start
and end dates (<code>(Date, Date)</code>):</p>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/c1.png"></p>

<p>If we need to represent a timeline split in to contiguous periods, it
may be tempting to represent this as a sequence of periods (e.g. <code>List
(Date, Date)</code>):</p>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/c2.png"></p>

<p>However, with this representation there can be both gaps in the
timeline and overlapping periods:</p>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/c3.png"></p>

<h3 id="improved-representation">Improved Representation</h3>

<p>We can improve this representation so that the contiguous and
non-overlapping constraints always hold, and we can do this in a way
that may remind you of database normalisation - by removing
redundancy.</p>

<p>In a well formed contiguous timeline, the joint start/end
of the adjacent periods are redundant. Contiguous, non-overlapping
splits can simply be represented by a set of dates (<code>Set Date</code>):</p>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/c4.png"></p>

<p>You can begin to see how this representation simplifies the system
when you consider how to make a further split in the timeline. In the
list representation, splitting a period requires carefully modifying
the data-structure and ensuring constraints aren’t violated. In the
‘set of dates’ representation you simply add a date to the set.</p>

<p>It is sometimes still useful to represent the periods as a sequence of
start and end dates. It is trivial to project the set of dates in to
this form. As long as the canonical representation is the set, the
constraints will still hold.</p>

<h2 id="case-2-default-contracts">Case 2: Default Contracts</h2>

<p>In this system, a customer pays us a recurring rent based upon a contract.
Contracts last for a fixed amount of time, and when they expire we fall back to
a ‘default contract’. The customer can have many fixed contracts, and can
sign new contracts at any time.</p>

<p>This was represented as:</p>
<ul>
  <li>A ‘customers’ table storing
    <ul>
      <li>The customer start date.</li>
      <li>An optional end date, should the customer leave.</li>
    </ul>
  </li>
  <li>A ‘contracts’ table storing
    <ul>
      <li>The contract start date.</li>
      <li>An optional end date, for default contracts that don’t end.</li>
      <li>If it was a ‘fixed’ or ‘default’ contract.</li>
    </ul>
  </li>
</ul>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/f1.png"></p>
<p>Customer and contract timelines</p>

<p>This representation allows for some undesirable states that are trivial to prevent:</p>
<ul>
  <li>The customer may have gaps in their contracts.</li>
  <li>A fixed contract may not have an end date.</li>
</ul>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/f2.png"></p>
<p>Contract gaps</p>

<p>To make matters worse, the API for these contracts allowed you to
modify each individual contract, fixed or default, without guarding against
these states. This shows how a poor choice of
representation propagates itself through the design of a system.</p>

<p>This poor choice was not just a theoretical problem -
gaps in contracts were found on more than one occasion, requiring
hours of engineering effort to hunt down and fix.</p>

<h3 id="improved-representation-1">Improved Representation</h3>

<p>This is easily improved by removing the ‘default’ contracts from the
contract table. If the customer doesn’t have a fixed contract, it is
assumed they are on a default contract:</p>

<p><img src="https://kevinmahoney.co.uk/img/articles/misu/f3.png"></p>
<p>Inferred default contracts</p>

<p>Now there can no longer be any gaps, and 
the end date of a contract no longer needs to be optional as it only represents fixed contracts.</p>

<p>It’s worth reiterating that this representation can be projected in to the previous
representation using a database view if that form is more convenient. What is
important is that the underlying representation enforces these constraints, it
is not important how you view the data.</p>

<p>As with the first case, a better representation makes the manipulation
of the data structure simpler. In this case, adding a new fixed contract is
greatly simplified. There is no need to create or modify default contracts, or ensure
that the contracts are contiguous.</p>

<h3 id="the-influence-of-object-oriented-thinking">The Influence of Object-Oriented Thinking</h3>

<p>If this improvement seems obvious to you, you may wonder how the
original design happened in the first place.</p>

<p>I think this happens because of atomistic, object-oriented thinking.</p>

<p>In this mindset, the fixed contracts are <em>objects</em>, the default contracts are
<em>objects</em>, and each of these concepts must be reified as a row in a table and
never inferred.
There is a distrust of using any features the database
offers beyond storing or retrieving <em>objects</em>.</p>

<p>This approach is antithetical to quality relational design and
the principle of making invalid states unrepresentable.</p>

<p>It may feel “simpler” on some level, as you don’t really need
to think about your design.
However, as we see here, this lack of forethought inevitably
leads to complexity.</p>

  </div>
</article></div>]]>
            </description>
            <link>https://kevinmahoney.co.uk/articles/applying-misu/</link>
            <guid isPermaLink="false">hacker-news-small-sites-24685772</guid>
            <pubDate>Mon, 05 Oct 2020 08:43:13 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[What you could steal from the Kakoune code editor, and get away with]]>
            </title>
            <description>
<![CDATA[
Score 177 | Comments 58 (<a href="https://news.ycombinator.com/item?id=24685267">thread link</a>) | @todsacerdoti
<br/>
October 5, 2020 | https://kakoune-editor.github.io/community-articles/2020/10/01/what_steal_get_away_kakoune.html | <a href="https://web.archive.org/web/*/https://kakoune-editor.github.io/community-articles/2020/10/01/what_steal_get_away_kakoune.html">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div id="content" role="main">
      <h2>What you could steal from the Kakoune code editor right now, and get away with it</h2>

<p><a href="https://kakoune.org/">Kakoune</a> is a (fairly) young modal code editor
that has matured for as long and as well as a good red wine. It places
multiple-selections, operability and interactivity at the heart of its
distinctive characteristics. It provides users with an efficient and
comfortable text editing experience — but that’s not what this article
is about.</p>

<p>Now 8 years old at the time of writing, Kakoune has gone through several
iterations that removed a dependency here, optimised a core feature there,
even factorised entire parts of its codebase! And as any long-term user
will tell you, it’s easy to take all that good stuff for granted.</p>

<p>So here it is. I’m stopping time for a couple minutes, and listing in
this article a few things that the Kakoune project does well in several
dimensions. Some are technical, but the rest should hopefully be easily
adaptable to other projects (whether they are code editors or not), and
generic enough to be adopted seamlessly.</p>

<p>Now why does the title of this piece mention stealing? Read on, that’s item
number one.</p>

<h2 id="from-its-licensing-model">From its licensing model</h2>

<p>If something doesn’t belong to anybody, is it stealing if you take it for
yourself? What if it belongs equally to everybody?</p>

<p>Fortunately we don’t need to solve that problem: Kakoune is a public domain
project. Which means that anyone is free to do anything they want with the
source code of the editor, no questions asked.</p>

<p>This has several advantages:</p>

<ul>
  <li>the tool can be shipped with any distribution or suite, regardless of
licensing</li>
  <li>users can modify the code (to fix bugs, add new features or tweak already
existing ones etc.) and publish it (or compiled binaries) without worrying
about attribution</li>
  <li>it lifts some weight of responsibility of the maintainer for the whole
project, which anyone can re-brand or heavily modify to their liking</li>
</ul>

<p>Users don’t like paying for tools, and when they are free and open-source,
I’d argue that they turn out to be more useful (with several iterations,
over time) in the end if they place no limits on what users are allowed to
do with the code.</p>

<p>I’m not in favour of abolishing licenses, I think it would be more
productive for everyone if specialised tools were in the public
domain. In fact, the Kakoune project <em>is</em> licensed, under the
<a href="https://choosealicense.com/licenses/unlicense/">terms</a> of the
<a href="https://unlicense.org/">UNLICENSE</a>, in order to avoid conflicts with
jurisdictions that don’t recognise the <em>public domain</em> model.</p>

<p>As for the small riddle above, that’s a tough one, bordering on the
philosophical, but since we’re talking about replicating data, we can easily
break out of that paradox: copying is not stealing.</p>

<h2 id="from-its-code">From its code</h2>

<p>New comers like to praise Kakoune for having a clean codebase, easy to
navigate and modify. And for good reason! Written in C++, the code uses the
smallest amount of bells and whistles possible to keep the code elegant,
compilable with (reasonably) old compiler versions, but more importantly
convenient.</p>

<p>And when it comes to convenience, Kakoune has some interesting assets your
project could benefit from:</p>

<ul>
  <li>a header-only implementation of a diffing algorithm
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/diff.hh">diff.hh</a>)</li>
  <li>a regex engine mostly following the ECMA syntax — this implementation
allowed the project to drop
<a href="https://www.boost.org/doc/libs/1_74_0/libs/regex/doc/html/index.html">boost::regex</a>
as a dependency
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/regex.hh">regex.hh</a>)</li>
  <li>a minimal JSON (un)marshaller
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/json.hh">json.hh</a>)</li>
  <li>a custom hash map implementation
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/hash_map.hh">hash_map.hh</a>)</li>
  <li>wrappers for string types (e.g. string view) and associated utilities:
join, wrap, split, quote, pad etc.
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/string.hh">string.hh</a>
· <a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/string_utils.hh">string_utils.hh</a>)</li>
  <li>various functional range filters: filter, transform, gather, map etc.
(<a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/ranges.hh">ranges.hh</a>)</li>
  <li>an implementation of Go’s defer statement that runs code once the execution
flow leaves the current scope
(<a href="https://golang.org/ref/spec#Defer_statements">Go specification</a>
· <a href="https://github.com/mawww/kakoune/blob/v2020.09.01/src/utils.hh#L53">utils.hh</a>)</li>
</ul>

<p>The above snippets are not exactly drop-in, as they are still coupled to
custom types defined for the editor, but should nonetheless be adaptable
without much difficulty to other C++ projects.</p>

<h2 id="from-its-user-interface">From its user interface</h2>

<p>Originally an easter-egg that savvy users found out about by reading the
code that handles the terminal client’s user interface, the Clippy character
has become a mascot that is now enabled out of the box. However, although
it’s undeniable that nostalgia for Microsoft Office’s assistant has fuelled
prolonged interest in Clippy itself, the easter egg’s notoriety has cast a
shadow on the larger feature it’s a prisoner of: the auto-info pop up window.</p>

<p>The auto-info window is a big contributor to the general level of
interactivity the editor provide, as it pops up any time the user hits a
key in normal mode or has typed a function name in the command prompt. Its
purpose is to provide instant feedback to the user, communicate usage
information or possible options that are available to the user. Every time
I’m using a terminal program that lets me type commands but never hints
at what parameters they take, I sorely wished more people would steal that
from Kakoune!</p>

<p>Another command prompt related improvement that the editor proposes is
fuzzy matching: the user doesn’t need to type out letters that make up
the name of the command they need in order, which makes for much faster
completion selection, and increased discoverability.</p>

<p>All command names in Kakoune are WORDS that start with the name of the
functionality group they belong to. The examples below follow:</p>

<ul>
  <li>to figure out what commands interact with the buffer, typing <code>:buff</code>
would return candidates like <code>buffer-next</code>, <code>lint-buffer</code>,
<code>format-buffer</code>…</li>
  <li>to call the <code>lint-buffer</code> command, typing <code>:lb&lt;tab&gt;</code> would insert the
entire command name in the prompt</li>
</ul>

<p>Use Kakoune once, and you’ll wish your browser enabled fuzzy
matching in your history/bookmarks for the rest of your days. But
you might wonder: there are individual tools that handles
fuzzy-matching, like <a href="https://github.com/junegunn/fzf">fzf</a>,
<a href="https://github.com/kien/ctrlp.vim">ctrlp</a> or
<a href="https://github.com/jhawthorn/fzy">fzy</a>, what if the user would rather
use them to handle opening, for example, files? Great question! Read on,
that’s the next dimension I want you to steal from.</p>

<h2 id="from-its-philosophy">From its philosophy</h2>

<p>The UNIX philosophy states that tools should focus on doing one thing,
and do it well. The implications are that tools that implement too many
unrelated features end up providing users with an underwhelming experience
because they only allow so much granularity over their behaviour, and that
their maintainers are spread too thin to improve/fix them.</p>

<p>If we re-frame this into the context of text editing, editors should only
worry about exactly that — text editing. And Kakoune does its job as
a UNIX citizen brilliantly, but it also goes one step further: it allows
other tools to interact with it, via shell scripting.</p>

<p>Remember the case of spawning a third-party fuzzy matching program,
above? Without getting into details, in Kakoune you’d implement that by
spawning a new terminal (or pane/tab), which would run the program, and
its output would be interpreted by the editor. Users are free to run any
program they want, any terminal or multiplexer they prefer.</p>

<p>And the concept isn’t bound to terminal programs either, although they are
probably the type of tools that Kakoune users would intuitively want to
interact with, on account of the editor being one itself. For example, do
you want to edit a file using a graphical interface? Try the following:</p>

<div><div><pre><code>:edit %sh{zenity --file-selection}
</code></pre></div></div>

<p>If that doesn’t sound anything special, it means that it makes
sense. Unfortunately, the field of text editors on UNIX systems has over
the years turned into an archipelago, in which every editor aims at being an
island. Job management, shell, terminal emulation,&nbsp;window multiplexing…
Text editors have turned into closed ecosystems (or Integrated Development
Environments) that provide many (sometimes cardboard-looking) features
unrelated to editing, which new comers have to buy into, or be left out in
the cold.</p>

<p>So here’s an idea everybody should not feel guilty about stealing, if
applicable to their projects: don’t re-invent the wheel, we have enough
bad imitations already<sup id="fnref:1" role="doc-noteref"><a href="#fn:1">1</a></sup> — instead, work on ways to make your tools
interface with others more easily!</p>

<p>If you have comments or questions, feel free to drop by the official IRC
channel: #kakoune @ FreeNode.</p>




<p>
    — written by

    

    <a href="https://github.com/lenormf">

    

        Frank Lenormand
    </a>

    · <time datetime="2020-10-01T00:00:00+00:00">
        <i>1st October 2020</i>
    </time>

    · license <strong>CC BY-SA 4.0</strong>
</p>


      
    </div></div>]]>
            </description>
            <link>https://kakoune-editor.github.io/community-articles/2020/10/01/what_steal_get_away_kakoune.html</link>
            <guid isPermaLink="false">hacker-news-small-sites-24685267</guid>
            <pubDate>Mon, 05 Oct 2020 07:07:36 GMT</pubDate>
        </item>
        <item>
            <title>
<![CDATA[Benchmarking static website hosting providers]]>
            </title>
            <description>
<![CDATA[
Score 165 | Comments 63 (<a href="https://news.ycombinator.com/item?id=24683403">thread link</a>) | @rencire
<br/>
October 4, 2020 | https://www.savjee.be/2020/05/benchmarking-static-website-hosting-providers/ | <a href="https://web.archive.org/web/*/https://www.savjee.be/2020/05/benchmarking-static-website-hosting-providers/">archive.org</a>
<br/><!-- hnss:readable-content --><hr/><div id="readability-page-1" class="page"><div>
        <p>Static websites are still a hot topic. They are fast, and they’re incredibly secure because there isn’t a CMS to hack. Once you build a static website, however, the question becomes: Where do I host?</p>

<p>In other words: what is the fastest static website hosting provider in 2020? Well, let’s find out!</p>

<!--more-->

<p>I did <a href="https://www.savjee.be/2017/10/Static-website-hosting-who-is-fastest/">a similar test in 2017</a>, so it will be curious to see if the hosting providers have been improving.</p>

<h2 id="test-setup">Test setup</h2>
<p>Just like in 2017, I created a simple webpage that I could host on many services. I opted to use my own homepage, including all the images, CSS, and JS files. I then uploaded these files to the following hosting providers:</p>

<ul>
  <li>
<strong>Pay-as-you-go</strong>
    <ul>
      <li>
<a href="https://aws.amazon.com/s3/" target="_blank" data-no-instant="data-no-instant">AWS S3</a> (Region: <code>eu-west-1</code>, Ireland)</li>
      <li><a href="https://aws.amazon.com/cloudfront/" target="_blank" data-no-instant="data-no-instant">AWS CloudFront</a></li>
      <li>
<a href="https://cloud.google.com/storage" target="_blank" data-no-instant="data-no-instant">Google Cloud Storage</a> (regional bucket, <code>europe-west1</code>, Belgium)</li>
      <li>
<a href="https://cloud.google.com/storage" target="_blank" data-no-instant="data-no-instant">Google Cloud Storage</a> (multi-region bucket)</li>
      <li>
<a href="https://workers.cloudflare.com/sites" target="_blank" data-no-instant="data-no-instant">Cloudflare Workers Sites</a> ($5/month)</li>
    </ul>
  </li>
  <li>
<strong>Freemium (some parts free)</strong>
    <ul>
      <li><a href="https://firebase.google.com/docs/hosting" target="_blank" data-no-instant="data-no-instant">Firebase Hosting</a></li>
      <li><a href="https://www.cloudflare.com/cdn/" target="_blank" data-no-instant="data-no-instant">Cloudflare CDN</a></li>
      <li><a href="https://www.cloudflare.com/cdn/" target="_blank" data-no-instant="data-no-instant">Netlify</a></li>
    </ul>
  </li>
  <li>
<strong>Free</strong>
    <ul>
      <li><a href="https://pages.github.com/" target="_blank" data-no-instant="data-no-instant">GitHub Pages</a></li>
    </ul>
  </li>
</ul>

<p><em>Quick note</em>: I did not test Microsoft Azure, because I couldn’t sign up for it with my <a href="https://revolut.com/referral/xavierh5x" target="_blank" data-no-instant="data-no-instant">Revolut Visa card</a>. Thanks, Microsoft!</p>

<p>To check the performance, I used Pingdom and <a href="https://ohdear.app/" target="_blank" data-no-instant="data-no-instant">Oh Dear</a>. Pingdom measures uptime and response times from <a href="https://my.pingdom.com/probes/feed" target="_blank" data-no-instant="data-no-instant">their worldwide network of probe servers</a> while Oh Dear is located in a single location.</p>

<p>Some other things to keep in mind:</p>

<ul>
  <li>I tested the HTTPS endpoints for all services</li>
  <li>I added <code>index.html</code> to all URL’s, meaning no time wasted resolving the index document</li>
  <li>The services were probed <strong>once every minute</strong> for <strong>10 days</strong>
</li>
  <li>Oh Dear did not only track response times, but also DNS lookup time,  TCP connection time, content download time, and more. Pretty cool! All of the raw data is available at the end of this post.</li>
</ul>

<p><strong>Note:</strong> Pingdom or Oh Dear did NOT sponsor this blog post in any way! <a href="https://ohdear.app/" target="_blank" data-no-instant="data-no-instant">Oh Dear</a>, however, gave me a free trial with enough slots for all the test sites. Thanks a lot!</p>

<h2 id="expectations">Expectations</h2>
<p>My expectations are pretty much aligned to when I did this last time around:</p>

<ul>
  <li>I expect paid services to do better than free servers. There must be a reason for the prices they charge, right?</li>
  <li>Firebase and Google Cloud belong to the same company, so I expect them to perform similarly.</li>
  <li>I use CloudFront for my website, so hopefully they don’t come out as a bad option. Otherwise, there’s some additional homework for me ;)</li>
  <li>Netlify performed quite inconsistently last time around. With a few years passing, I hope they were able to address those issues.</li>
  <li>Last time, I didn’t have Cloudflare in the benchmark. I expect them to be a strong contender, given how popular they are and how many edge locations they have.</li>
</ul>

<h2 id="results">Results</h2>
<p>Here’s a screenshot from the Pingdom dashboard after 10 days of testing:</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/pingdom-overview.png" alt="Overview of the Pingdom dashboard">
<em>Overview of the Pingdom dashboard</em></p>

<p>At first glance, it seems that all services perform very consistently, with CloudFront, GitHub Pages, and Google Cloud, leading the pack. But let’s not jump to conclusions.</p>

<h3 id="uptime">Uptime</h3>
<p>Let’s start with uptime. All of these services had 100% uptime, except for Firebase. Pingdom detected 1 minute of downtime. One check returned, “Network is unreachable,” and the other returned “Invalid certificate.”</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/pingdom-error-log.png" alt="Firebase downtime as reported by Pingdom">
<em>Firebase downtime as reported by Pingdom</em></p>

<p>This was not detected by Oh Dear, so I’m willing to give Firebase the benefit of the doubt and say that this was an issue on Pingdom’s side.</p>

<h3 id="response-times">Response times</h3>
<p>Let’s start with some basic statistics: the median, and average response time of each service (including standard deviation):</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-response-times.png" alt="Median response times, measured by Pingdom">
<em>Median response times as reported by Pingdom</em></p>

<p>A few things might catch your attention:</p>

<ul>
  <li>CloudFront &amp; GitHub Pages are speedy and consistent. They have the lowest median, average, and deviation. Interesting because one is a paid service, while the other is completely free.</li>
  <li>AWS S3 is the slowest of them all (but performs consistently). It is kind of expected from a hosting provider that is located only in a single region (in this case Ireland, <code>eu-west-1</code>)</li>
  <li>Google Cloud’s regional and multi-regional buckets perform fairly alike. Interestingly, both are much faster than S3, which is a comparable service. Is Google doing some caching behind the scenes?</li>
  <li>I expected Cloudflare to be much more competitive with the top rankings, but somehow both their CDN and Workers aren’t the top performers. Their Workers product does, however, perform slightly better than their CDN.</li>
</ul>

<p>Since I used both Pingdom and Oh Dear, let’s check the difference in median response times:</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-response-times-pingdom-oh-dear.png" alt="Pingdom vs Oh Dear (median response times)">
<em>Pingdom vs Oh Dear (median response times)</em></p>

<p>Interestingly, Oh Dear is reporting much faster response times compared to Pingdom. This is probably related to the fact that they only test from a single (apparently very well connected) location.</p>

<p>Pingdom is testing from various locations around the world, some of which aren’t as well connected, which increases the response times.</p>

<p>Some additional findings:</p>

<ul>
  <li>Somehow, AWS S3 is the fastest performer, even though the content is only hosted in a single location. It also outperformed Amazon’s CDN! Wherever Oh Dear is hosted, it must be somewhere in the EU with good connections to the Ireland region of AWS.</li>
  <li>The difference between CloudFront, S3, Firebase, GitHub Pages, and Google Cloud Storage is minimal. Once more, showing that free and paid services compete quite closely with one another.</li>
</ul>

<h3 id="time-to-first-byte">Time to first byte</h3>
<p>Oh Dear also kept track of other metrics like how long it took for the first bytes to start being transferred. This can give us an indication of how responsive the webserver is (how long does it need to think before being able to fulfill a request).</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-time-to-first-byte.png" alt="Time to first byte: measures responsiveness of web servers">
<em>Time to first byte: measures responsiveness of web servers</em></p>

<ul>
  <li>The “simple” storage services like S3 and Google Cloud Storage are doing very well.</li>
  <li>Once again, GitHub Pages, Firebase, and CloudFront are great performers, delivering the first byte in under 40ms.</li>
  <li>Surprisingly, Cloudflare is taking quite a while to start delivering the first bytes. Maybe this is due to all of their protection services?</li>
</ul>

<h3 id="compared-to-2017">Compared to 2017</h3>
<p>Comparing this new data with the one from 2017 reveals that not much has changed. Note that here I’m comparing the data from Pingdom:</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-response-times-2017-vs-2020.png" alt="Benchmark from 2017 vs 2020: median response times">
<em>Benchmark from 2017 vs 2020: median response times</em></p>

<p>All providers (except GitHub Pages) have become slightly slower. Most noticeably AWS S3 (+13%) and Firebase (+31%). The others are so close to their 2017 performance that I would consider these differences to be in the margin of error.</p>

<p>Netlify has a slower median response time in 2020 compared to 2017. But it did improve massively on its consistency. Last time around, they had weird spikes in performance but not anymore. Nice!</p>

<p>This could be explained by Pingdom having added additional test servers located in areas that are further away from these providers.</p>

<h3 id="trying-to-find-edge-cases">Trying to find edge cases</h3>
<p>A scatter plot reveals that there aren’t many outliers, and no service is suffering from regular spikes in performance. There are some outliers here and there, but I wouldn’t look into them too much:</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-scatter-response-times.png" alt="Scatter plot of all response times">
<em>Scatter plot of all response times</em></p>

<p>If we visualize the response times with a box plot, we see something interesting:</p>

<p><img src="https://www.savjee.be/uploads/2020-05-28-benchmaring-static-website-hosting-providers/chart-boxplot-response-times.png" alt="Box plot of response times, showing some high spikes">
<em>Box plot of response times, showing some high spikes</em></p>

<p>All services, except for AWS, GitHub Pages, and Firebase, have weird spikes. Last time around, this was only limited to Netlify. Not sure what to make of these, but I’m guessing it’s more related to Pingdom’s tests than to the services themselves.</p>

<h2 id="conclusions">Conclusions</h2>
<p>Time to draw some conclusions:</p>

<p>The best all-around performer is <strong>AWS CloudFront</strong>, followed closely by <strong>GitHub Pages</strong>. Not only do they have the fastest response times (median), they’re also the most consistent.</p>

<p>They are, however, closely followed by Google Cloud Storage. Interestingly, there is very little difference between a regional and multi-regional bucket. The only reason to pick a multi-regional bucket would be the additional uptime guarantee.</p>

<p><strong>Cloudflare</strong> didn’t perform as well I would’ve expected. It’s certainly faster than a standard S3 bucket but falls away when compared to other CDN’s like CloudFront. Their Workers product is slightly faster than their CDN, but it’s hard to recommend it when it costs $5 a month, and free products like GitHub Pages perform better.</p>

<p>Netlify has improved big time; the spikes in performance are gone and performs in line with Google Cloud and Firebase hosting.</p>

<h2 id="which-should-you-choose">Which should you choose?</h2>
<p>If you want a fast website without breaking the bank, go for GitHub Pages. It’s completely free and super fast. It does, however, require you to open source your site.</p>

<p>If that’s not doable, CloudFront is a good alternative, but its price depends on how much bandwidth you push around. For most personal sites, CloudFront won’t cost more than a couple of dollars per month. The same thing goes for Google Cloud Storage.</p>

<p>Netlify and Firebase Hosting are pretty solid choices as well. While they don’t perform as well as CloudFront or GitHub Pages, they make up for it with excellent development tools. Everything works out-of-the-box with no configuration required on your end. Just push your website live with their easy to use CLI tools.</p>

<h2 id="download-the-data">Download the data</h2>
<p>The raw CSV data <a href="https://github.com/Savjee/static-website-hosting-benchmark" target="_blank" data-no-instant="data-no-instant">is available on GitHub</a>. Both of 2017 and 2020. Feel free to do your analysis and let me know if you find other interesting things in the dataset. Definitely check out the detailed statistics from Oh Dear!</p>

    </div></div>]]>
            </description>
            <link>https://www.savjee.be/2020/05/benchmarking-static-website-hosting-providers/</link>
            <guid isPermaLink="false">hacker-news-small-sites-24683403</guid>
            <pubDate>Mon, 05 Oct 2020 00:24:13 GMT</pubDate>
        </item>
    </channel>
</rss>
